(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[538],{3126:function(e,t,n){(window.__NEXT_P=window.__NEXT_P||[]).push(["/map",function(){return n(8035)}])},8035:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return ae}});var r=n(1250),o=n(6529),i=n(9901),a=n(7329),u=n(8833),c=n(8507),s=n(5304);function l(e){var t=e.msg;return(0,r.jsxs)("div",{className:"flex justify-center w-full flex-column content",children:[(0,r.jsx)(s.Z,{className:"w-20 animate-spin"}),t?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("br",{}),(0,r.jsx)("p",{children:t})]}):null]})}function d(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=[],r=!0,o=!1,i=void 0;try{for(var a,u=e[Symbol.iterator]();!(r=(a=u.next()).done)&&(n.push(a.value),!t||n.length!==t);r=!0);}catch(c){o=!0,i=c}finally{try{r||null==u.return||u.return()}finally{if(o)throw i}}return n}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}function f(e){return function(e){if(Array.isArray(e)){for(var t=0,n=new Array(e.length);t<e.length;t++)n[t]=e[t];return n}}(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}var p={visibility:"visible"},y=function(e){var t,n=e.geojson,o=e.onSelectFeature,u=e.circleCases,c=void 0===u?[]:u,s=i.useCallback((function(e){e.preventDefault();var t=d(e.target.queryRenderedFeatures(e.point),1)[0];"Point"===(null===t||void 0===t?void 0:t.geometry.type)?o(t):console.error("no feature found under pointer :thinking:",t)}),[o]),l=i.useCallback((function(e){e.target.getCanvas().style.cursor="pointer"}),[]),y=i.useCallback((function(e){e.target.getCanvas().style.cursor=""}),[]);return(0,r.jsx)(a.Wy,{data:n,circleLayout:p,circlePaint:(t=c,{"circle-color":["case"].concat(f(t),["black"]),"circle-radius":5}),circleOnClick:s,circleOnMouseEnter:l,circleOnMouseLeave:y})},v=n(2106),m=n(4221),h=function(){var e=(0,u.wl)().value,t=e.luggage,n=e.urls,r=e.sensorType,a=(0,m.useRouter)();(0,i.useEffect)((function(){(function(e,t){return e===o.R3&&t})(r,t)||n.length&&!n.some((function(e){return!e}))||(console.warn("no datasource detected, routing back to homepage"),a.push("/"))}),[n,a,r,t])},g=n(4168),b=n(1371);function x(e){var t=e.error,n=e.datasource;return(0,r.jsxs)("div",{className:"p-2",children:[(0,r.jsx)("h1",{children:"Error"}),(0,r.jsx)("h2",{children:"Failed to load map data."}),(0,r.jsx)("p",{children:"string"===typeof t?t:(0,r.jsx)("pre",{children:JSON.stringify(t,null,2)})}),(0,r.jsxs)("p",{children:["Are you sure your datasource is correct?",(0,r.jsx)("pre",{children:JSON.stringify(n,null,2)})]})]})}function j(){return(0,r.jsx)("p",{className:"p-2",children:"The datafile provided could not be converted into geojson format. Generally, this occurs because the columns in the data sheet do not match the expected field names."})}var w=n(8832);function k(){return(0,r.jsx)(w.default,{children:(0,r.jsx)("link",{href:"https://api.mapbox.com/mapbox-gl-js/v2.6.1/mapbox-gl.css",rel:"stylesheet"})},"mapboxstyle")}var O=n(4235),S=n.n(O),P=n(9976);function E(e,t,n,r,o,i,a){try{var u=e[i](a),c=u.value}catch(s){return void n(s)}u.done?t(c):Promise.resolve(c).then(r,o)}function N(e){return function(){var t=this,n=arguments;return new Promise((function(r,o){var i=e.apply(t,n);function a(e){E(i,r,o,a,u,"next",e)}function u(e){E(i,r,o,a,u,"throw",e)}a(void 0)}))}}function A(e){return C.apply(this,arguments)}function C(){return(C=N(S().mark((function e(t){return S().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t.addControl(new P.Ex,"bottom-right"),t.addControl(new P.Ly,"bottom-right"),t.addControl(new P.jP,"bottom-right");case 3:case"end":return e.stop()}}),e)})))).apply(this,arguments)}var D=n(1804),F=n(5087);function R(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var _=function(e){var t=e.dateField,n=e.endDate,r=e.isFilterAfterStart,o=e.isFilterBeforeEnd,a=e.startDate,u=e.unfilteredGeojson;return i.useMemo((function(){if(!r&&!o)return u;if(!t)throw new Error("sensor type missing dateField column name");var e=null===u||void 0===u?void 0:u.features;return e?function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},r=Object.keys(n);"function"===typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),r.forEach((function(t){R(e,t,n[t])}))}return e}({},u,{features:e.filter((function(e){var i=new Date(e.properties[t]);return!(r&&i<=a)&&!(o&&i>=n)}))}):u}),[t,n,r,o,a,u])},T=n(2573),L=(n(8651),n(1268)),M=n(9922),I=n(4657),B=n(7839),q=n(2462),Z=n(511),G=n(2242),H=n(2220),J=n(4531),K=function(e){var t,n=e.geojson;return!!(null===(t=n.features[0])||void 0===t?void 0:t.properties.pocketlabsEntry)?(0,r.jsx)(L.h,{aspect:3,width:"100%",children:(0,r.jsxs)(M.w,{data:n.features,margin:{top:5,right:30,left:20,bottom:5},children:[(0,r.jsx)(I.q,{strokeDasharray:"3 3"}),(0,r.jsx)(B.K,{dataKey:"name",label:"Time"}),(0,r.jsx)(q.B,{yAxisId:"left",children:(0,r.jsx)(Z._,{angle:-90,value:"ug/m3",position:"insideLeft",style:{textAnchor:"middle"}})}),(0,r.jsx)(q.B,{yAxisId:"right",orientation:"right",children:(0,r.jsx)(Z._,{angle:90,value:"Relative Humidity %",position:"insideRight",style:{textAnchor:"middle"}})}),(0,r.jsx)(G.u,{}),(0,r.jsx)(H.D,{wrapperStyle:{marginLeft:10},align:"right",verticalAlign:"middle",layout:"vertical"}),(0,r.jsx)(J.x,{yAxisId:"left",type:"monotone",dataKey:function(e){return e.properties.pm_2_5},name:"PM2.5 (MW)",stroke:"red",activeDot:{r:8}}),(0,r.jsx)(J.x,{yAxisId:"left",type:"monotone",dataKey:function(e){return e.properties.pocketlabsEntry.pm_2_5},name:"PM2.5 (PL)",stroke:"blue",activeDot:{r:8}}),(0,r.jsx)(J.x,{yAxisId:"right",type:"monotone",dataKey:function(e){return e.properties.pocketlabsEntry.humidity},name:"Humidity (PL)",stroke:"lightslategray"})]})}):(0,r.jsx)("p",{children:"Pocketlabs data is missing. Please upload a pocket labs file."})};function W(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function X(e){return(X=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function Y(e,t){return!t||"object"!==V(t)&&"function"!==typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function Q(e,t){return(Q=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var V=function(e){return e&&"undefined"!==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e};function z(e){var t=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=X(e);if(t){var o=X(this).constructor;n=Reflect.construct(r,arguments,o)}else n=r.apply(this,arguments);return Y(this,n)}}var U=function(e){!function(e,t){if("function"!==typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Q(e,t)}(a,e);var t,n,o,i=z(a);function a(e){var t;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,a),(t=i.call(this,e)).state={error:null},t}return t=a,o=[{key:"getDerivedStateFromError",value:function(e){return{error:String(e)}}}],(n=[{key:"render",value:function(){return this.state.error?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("h1",{children:"Something went wrong."}),(0,r.jsx)("pre",{children:this.state.error})]}):this.props.children}}])&&W(t.prototype,n),o&&W(t,o),a}(i.Component);function $(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=[],r=!0,o=!1,i=void 0;try{for(var a,u=e[Symbol.iterator]();!(r=(a=u.next()).done)&&(n.push(a.value),!t||n.length!==t);r=!0);}catch(c){o=!0,i=c}finally{try{r||null==u.return||u.return()}finally{if(o)throw i}}return n}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}function ee(e){return function(e){if(Array.isArray(e)){for(var t=0,n=new Array(e.length);t<e.length;t++)n[t]=e[t];return n}}(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}var te=function(e){return!e.toString().match(/Invalid/)},ne=(0,c.default)((function(){return n.e(991).then(n.bind(n,6991))}),{loadableGenerated:{webpack:function(){return[6991]},modules:["../src/components/pages/map/index.tsx -> ../../MeasurementPopup"]}}),re=function(e,t){return{url:"api.mapbox.com"===e.slice(8,22)||"tiles.mapbox.com"===e.slice(10,26)?e.replace("?","?pluginName=sheetMapper&"):e}},oe=new Date("2020-01-01"),ie=new Date("".concat((new Date).getFullYear(),"-12-31"));function ae(){var e;h();var t,n=(0,i.useState)(""),c=n[0],s=n[1],d=(0,i.useState)(!0),f=d[0],p=d[1],m=(0,i.useState)(!1),w=m[0],O=m[1],S=(0,i.useState)(oe),P=S[0],E=S[1],N=(0,i.useState)(!1),C=N[0],R=N[1],L=(0,i.useState)(ie),M=L[0],I=L[1],B=(0,i.useState)(!1),q=B[0],Z=B[1],G=$(i.useState(),2),H=G[0],J=G[1],W=$(i.useState([-122.66155,45.54846]),2),X=W[0],Y=W[1],Q=(0,u.wl)(),V=Q.value,z=V.urls,ae=V.sensorType,ue=(0,g.rk)(ae),ce=ue.isLoading,se=ue.error,le=ue.data,de=(null===le||void 0===le?void 0:le.mapbox)||{},fe=de.getLevels,pe=de.getLevelsByField,ye=c?null===pe||void 0===pe?void 0:pe[c]:fe,ve=(null===le||void 0===le?void 0:le.download)||{},me=ve.downloadGeoJSON,he=ve.dateField,ge=(0,b.useQuery)({queryKey:["map","sensor-".concat(ae)].concat(ee(z),["undefined"===typeof me?"undefined":(t=me,t&&"undefined"!==typeof Symbol&&t.constructor===Symbol?"symbol":typeof t)]),queryFn:function(){var e,t=null===(e=Q.value)||void 0===e?void 0:e.luggage;if(ae===o.R3&&t)return Promise.resolve(t);if(me)return me(z);throw new Error("no mechanism found to download map data")},cacheTime:1e9}),be=ge.isLoading,xe=ge.error,je=ge.data,we=se||xe,ke=ce||be,Oe=_({unfilteredGeojson:je,dateField:he||"",startDate:P,isFilterAfterStart:w,isFilterBeforeEnd:C,endDate:M}),Se=(0,i.useMemo)((function(){return ye&&Oe?ye({isMinMaxDynamicRange:f,geojson:Oe}):null}),[ye,f,Oe]);!function(e,t){(0,i.useEffect)((function(){if(e){var n=(0,v.VWR)(e);n[0]<=-1/0||n[0]>=1/0?console.error("infinity detected. bounds skipped"):t(n)}}),[e])}(Oe,J);var Pe=i.useRef((0,a.ZP)({accessToken:"pk.eyJ1IjoicGR4Y2xlYW5haXIiLCJhIjoiY2tweDFuZmxpMjFmbzJ3bXVkajd4dDQ4dSJ9.LYiRB4TgOAckcqZGi-cUXg",transformRequest:re})).current,Ee=$(i.useState(null),2),Ne=Ee[0],Ae=Ee[1],Ce=function(){return Ae(null)};if((0,i.useEffect)((function(){var e=function(e){e.key.match(/esc/i)&&Ce()},t=function(e){return Ce()},n=$(document.getElementsByTagName("canvas")||[],1)[0];return null===n||void 0===n||n.addEventListener("click",t),window.addEventListener("keyup",e),function(){window.removeEventListener("keyup",e),null===n||void 0===n||n.removeEventListener("click",t)}}),[Ne]),we)return(0,r.jsx)(x,{error:we,datasource:Q});if(ke)return(0,r.jsx)(l,{msg:"Downloading data"});if(!Oe)return(0,r.jsx)(l,{msg:"Preparing geojson"});var De=null===(e=null===Oe||void 0===Oe?void 0:Oe.features[0])||void 0===e?void 0:e.properties;return(0,r.jsxs)(U,{children:[(0,r.jsx)(k,{}),(0,r.jsxs)(Pe,{onStyleLoad:A,className:"w-full content",fitBounds:H,center:X,style:"mapbox://styles/pdxcleanair/ckpx7yno443sa17p6iy65qn95",containerStyle:{height:"100%",width:"100vw"},children:[De?void 0:(0,r.jsx)(j,{}),Oe&&(0,r.jsx)(y,{geojson:Oe,circleCases:null===Se||void 0===Se?void 0:Se.circleCases,onSelectFeature:function(e){H&&J(void 0),X&&Y(e.geometry.coordinates),Ae(e)}}),Ne?(0,r.jsx)(ne,{title:"Measurements",className:"overflow-auto h-96",feature:Ne,onClick:function(e){e.preventDefault()}}):void 0,(0,r.jsxs)("div",{id:"pollution-map-overlay",className:"map-overlay",children:[(0,r.jsxs)("div",{className:"map-overlay-control map-legend",children:[(0,r.jsx)("div",{style:{fontWeight:"bold"},children:null===Se||void 0===Se?void 0:Se.fieldName}),null===Se||void 0===Se?void 0:Se.ranges.map((function(e,t){var n=$(e,2),o=n[0],i=n[1];return(0,r.jsxs)("div",{children:[(0,r.jsx)("span",{style:{backgroundColor:Se.colors[t]},className:"map-legend-key"}),(0,r.jsxs)("span",{children:["[",o<1?o.toFixed(3):o.toFixed(1),","," ",i<1?i.toFixed(3):i.toFixed(1),")"]})]},"".concat(f,"-").concat(t))}))]}),pe?(0,r.jsxs)("div",{className:"map-overlay-control map-pollution-range-mode",children:[(0,r.jsx)("h4",{className:"font-bold",children:"Field to map"}),Object.keys(pe).map((function(e,t){return(0,r.jsxs)("div",{children:[(0,r.jsx)("input",{type:"radio",name:"field-to-map",onClick:function(){return s(e)},defaultChecked:0===t},e),(0,r.jsx)("label",{htmlFor:"field-to-map",children:" ".concat(e)}),(0,r.jsx)("br",{})]},e)}))]}):null,(0,r.jsxs)("div",{className:"map-overlay-control map-pollution-range-mode",children:[(0,r.jsx)("input",{type:"checkbox",checked:f,onChange:function(){return p(!f)}})," ","Dynamic Levels"]}),(0,r.jsxs)("div",{className:"map-overlay-control map-pollution-range-mode",children:[(0,r.jsx)("input",{type:"checkbox",checked:w,onChange:function(){return O(!w)}})," ","After Date",(0,r.jsx)("br",{}),(0,r.jsx)("input",{type:"datetime-local",disabled:!w,value:(0,F.Z)(P,"yyyy-MM-dd'T'HH:mm"),onChange:function(e){var t=new Date(e.currentTarget.value);te(t)&&E(t)}})]}),(0,r.jsxs)("div",{className:"map-overlay-control map-pollution-range-mode",children:[(0,r.jsx)("input",{type:"checkbox",checked:C,onChange:function(){return R(!C)}})," ","End Date",(0,r.jsx)("br",{}),(0,r.jsx)("input",{type:"datetime-local",disabled:!C,value:(0,F.Z)(M,"yyyy-MM-dd'T'HH:mm"),onChange:function(e){var t=new Date(e.currentTarget.value);te(t)&&I(t)}})]}),ae===o.R3?(0,r.jsx)("div",{className:"map-overlay-control map-pollution-range-mode",children:(0,r.jsx)(D.Z,{onClick:function(){Z(!q)},children:"Show charts"})}):null]})]}),(0,r.jsx)(T.R,{blocking:!1,open:q,onDismiss:function(){return Z(!1)},children:(0,r.jsxs)("div",{className:"p-4",children:[(0,r.jsx)("h3",{children:"PM2.5 & Humidity - MiniWRAS & PocketLabs"}),(0,r.jsx)(K,{geojson:Oe})]})})]})}},1804:function(e,t,n){"use strict";var r=n(1250),o=n(5789);n(9901);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t){if(null==e)return{};var n,r,o=function(e,t){if(null==e)return{};var n,r,o={},i=Object.keys(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var u="bg-gray-600 hover:bg-gray-700 focus:ring-gray-500 focus:ring-offset-gray-200",c="flex";t.Z=function(e){var t=e.styles,n=void 0===t?{}:t,s=n.bg,l=void 0===s?u:s,d=n.display,f=void 0===d?c:d,p=e.type,y=void 0===p?"button":p,v=e.className,m=a(e,["styles","type","className"]),h=(0,o.Z)(v,l,f,"py-2 px-4 justify-center items-center text-white transition ease-in duration-200 text-center text-base font-semibold shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 rounded-lg",m.disabled?"bg-gray-400 hover:bg-gray-400 cursor-not-allowed":"");return(0,r.jsx)("button",function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},r=Object.keys(n);"function"===typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),r.forEach((function(t){i(e,t,n[t])}))}return e}({type:y,className:h},m))}},4168:function(e,t,n){"use strict";n.d(t,{SR:function(){return s},pW:function(){return l},rk:function(){return d}});var r=n(4235),o=n.n(r),i=n(1371),a=n(6529);function u(e,t,n,r,o,i,a){try{var u=e[i](a),c=u.value}catch(s){return void n(s)}u.done?t(c):Promise.resolve(c).then(r,o)}function c(e){return function(){var t=this,n=arguments;return new Promise((function(r,o){var i=e.apply(t,n);function a(e){u(i,r,o,a,c,"next",e)}function c(e){u(i,r,o,a,c,"throw",e)}a(void 0)}))}}var s=function(){return n.e(368).then(n.bind(n,6368)).then((function(e){return e.getResources()}))},l=function(){return n.e(849).then(n.bind(n,7849)).then(c(o().mark((function e(t){return o().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",t.getResources());case 1:case"end":return e.stop()}}),e)}))))},d=function(e){return(0,i.useQuery)({queryKey:"get-mapping-".concat(e),queryFn:c(o().mark((function t(){var r;return o().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,e===a.p4?s():e===a.OS?n.e(339).then(n.bind(n,339)).then(c(o().mark((function e(t){var r;return o().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Promise.all([n.e(87),n.e(910)]).then(n.bind(n,2910));case 2:return r=e.sent.closestTo,e.abrupt("return",t.getResources({closestTo:r}));case 4:case"end":return e.stop()}}),e)})))):e===a.R3?l():e===a.xV?n.e(981).then(n.bind(n,5981)).then(c(o().mark((function e(t){var r;return o().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Promise.all([n.e(87),n.e(910)]).then(n.bind(n,2910));case 2:return r=e.sent.closestTo,e.abrupt("return",t.getResources({closestTo:r}));case 4:case"end":return e.stop()}}),e)})))):function(){throw new Error("unsupported sensor type ".concat(e))}();case 2:return r=t.sent,t.abrupt("return",r);case 4:case"end":return t.stop()}}),t)}))),cacheTime:1e9})}}},function(e){e.O(0,[774,138,221,573,87,710,888,179],(function(){return t=3126,e(e.s=t);var t}));var t=e.O();_N_E=t}]);
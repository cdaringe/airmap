(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[890],{54109:(e,t,n)=>{(window.__NEXT_P=window.__NEXT_P||[]).push(["/map",function(){return n(84377)}])},84377:(e,t,n)=>{"use strict";n.r(t),n.d(t,{default:()=>en});var r=n(34618),i=n(12551),s=n(61760),o=n(70573),a=n(65723),l=n(43794),u=n.n(l),c=n(22155),d=n(13578),f=n(29928);n(50936);var p=n(52062),m=n(29766),h=n(521),v=function(){var e=(0,h.xw)().value,t=e.luggage,n=e.urls,r=e.sensorType,i=(0,m.useRouter)();(0,c.useEffect)(function(){(r!==p.Dr||!t)&&(!n.length||n.some(function(e){return!e}))&&(console.warn("no datasource detected, routing back to homepage"),i.push("/"))},[n,i,r,t])},y=n(33139);function g(e){var t=e.msg;return(0,a.jsxs)("div",{className:"flex justify-center w-full flex-column content",children:[(0,a.jsx)(y.A,{className:"w-20 animate-spin"}),t?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("br",{}),(0,a.jsx)("p",{children:t})]}):null]})}var x=n(88910),j=n(61455),b=n(91249),k=function(e){function t(e){var n;return(0,j._)(this,t),(n=(0,x._)(this,t,[e])).state={error:null},n}return(0,b._)(t,e),t.prototype.render=function(){return this.state.error?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("h1",{children:"Something went wrong."}),(0,a.jsx)("pre",{children:this.state.error})]}):this.props.children},t.getDerivedStateFromError=function(e){return{error:String(e)}},t}(c.Component),_={visibility:"visible"},w=function(e){var t=e.onSelectFeature;return c.useMemo(function(){return{layerId:"pollution",onClick:function(e,n){"Point"===n.geometry.type&&t(n)},onMouseEnter:function(e){e.target.getCanvas().style.cursor="pointer"},onMouseLeave:function(e){e.target.getCanvas().style.cursor=""}}},[t])},D=function(e){var t,n=e.id,r=e.geojson,i=e.circleCases;return r?(0,a.jsx)(d.kL,{id:n,type:"geojson",data:r,children:(0,a.jsx)(d.Wd,{id:n,type:"circle",layout:_,paint:(t=void 0===i?[]:i,{"circle-color":["case"].concat((0,s._)(t),["black"]),"circle-radius":5})})}):null},F=n(26237),S=n(92831),E=function(e){var t=e.dateField,n=e.endDate,i=e.isFilterAfterStart,s=e.isFilterBeforeEnd,o=e.startDate,a=e.unfilteredGeojson;return c.useMemo(function(){if(!i&&!s)return a;if(!t)throw Error("sensor type missing dateField column name");var e=null==a?void 0:a.features;return e?(0,S._)((0,r._)({},a),{features:e.filter(function(e){var r=new Date(e.properties[t]);return(!i||!(r<=o))&&(!s||!(r>=n))})}):a},[t,n,i,s,o,a])},N=n(22774),M=function(e){var t=e.mapRef,n=e.className,r=(0,i._)(c.useState(0),2),s=r[0],o=r[1],a=c.useMemo(function(){return setInterval(function(){o(function(e){return e+1})},50)},[]),l=t.current;c.useEffect(function(){if(l){clearInterval(a);var e=l.getContainer();e.className.includes(n)||(e.className+=" "+n)}},[a,l,n,s])},A=n(22297),C=n(64450),I=n(25366),L=n(71532),R=n(87995),T=n(45188),B=n(88229),P=n(66257),H=n(67241),O=n(90446),J=function(e){var t,n=e.geojson;return(null===(t=n.features[0])||void 0===t?void 0:t.properties.pocketlabsEntry)?(0,a.jsx)(C.u,{aspect:3,width:"100%",children:(0,a.jsxs)(I.b,{data:n.features,margin:{top:5,right:30,left:20,bottom:5},children:[(0,a.jsx)(L.d,{strokeDasharray:"3 3"}),(0,a.jsx)(R.W,{dataKey:"name",label:"Time"}),(0,a.jsx)(T.h,{yAxisId:"left",children:(0,a.jsx)(B.J,{angle:-90,value:"ug/m3",position:"insideLeft",style:{textAnchor:"middle"}})}),(0,a.jsx)(T.h,{yAxisId:"right",orientation:"right",children:(0,a.jsx)(B.J,{angle:90,value:"Relative Humidity %",position:"insideRight",style:{textAnchor:"middle"}})}),(0,a.jsx)(P.m,{}),(0,a.jsx)(H.s,{wrapperStyle:{marginLeft:10},align:"right",verticalAlign:"middle",layout:"vertical"}),(0,a.jsx)(O.N,{yAxisId:"left",type:"monotone",dataKey:function(e){return e.properties.pm_2_5},name:"PM2.5 (MW)",stroke:"red",activeDot:{r:8}}),(0,a.jsx)(O.N,{yAxisId:"left",type:"monotone",dataKey:function(e){return e.properties.pocketlabsEntry.pm_2_5},name:"PM2.5 (PL)",stroke:"blue",activeDot:{r:8}}),(0,a.jsx)(O.N,{yAxisId:"right",type:"monotone",dataKey:function(e){return e.properties.pocketlabsEntry.humidity},name:"Humidity (PL)",stroke:"lightslategray"})]})}):(0,a.jsx)("p",{children:"Pocketlabs data is missing. Please upload a pocket labs file."})},Y=function(e){var t=e.isOpen,n=e.onDismiss,r=e.geojson;return(0,a.jsx)(A.X,{blocking:!1,open:t,onDismiss:function(){return n(!1)},children:(0,a.jsxs)("div",{className:"p-4",children:[(0,a.jsx)("h3",{children:"PM2.5 & Humidity - MiniWRAS & PocketLabs"}),(0,a.jsx)(J,{geojson:r})]})})},G=n(67597),K=n.n(G);function q(){return(0,a.jsx)(K(),{children:(0,a.jsx)("link",{href:"https://api.mapbox.com/mapbox-gl-js/v3.9.3/mapbox-gl.css",rel:"stylesheet"})},"mapboxstyle")}function W(e){var t=e.error,n=e.datasource;return(0,a.jsxs)("div",{className:"p-2",children:[(0,a.jsx)("h1",{children:"Error"}),(0,a.jsx)("h2",{children:"Failed to load map data."}),(0,a.jsx)("p",{children:"string"==typeof t?t:(0,a.jsx)("pre",{children:JSON.stringify(t,null,2)})}),(0,a.jsxs)("p",{children:["Are you sure your datasource is correct?",(0,a.jsx)("pre",{children:JSON.stringify(n,null,2)})]})]})}function X(){return(0,a.jsx)("p",{className:"p-2",children:"The datafile provided could not be converted into geojson format. Generally, this occurs because the columns in the data sheet do not match the expected field names."})}var Q=n(974),Z=n(48747),z=function(e){return!e.toString().match(/Invalid/)},V=new Date("2020-01-01"),U=new Date("".concat(new Date().getFullYear(),"-12-31")),$=function(e,t){for(var n,r=arguments.length,i=Array(r>2?r-2:0),s=2;s<r;s++)i[s-2]=arguments[s];return null===(n=e.features)||void 0===n?void 0:n.forEach(function(n){return i.forEach(function(r){var i;null===(i=r[t])||void 0===i||i.call(r,e,n)})})},ee=function(e){var t=e.sensorType,n=e.setIsBottomSheetOpen,r=e.setEndDate,s=e.startDate,o=e.setStartDate,l=e.setMappingField,u=e.setIsMinMaxDynamicRange,c=e.setIsFilteringAfterStart,d=e.setIsFilterBeforeEnd,f=e.levels,m=e.isMinMaxDynamicRange,h=e.isBottomSheetOpen,v=e.isFilterBeforeEnd,y=e.isFilterAfterStart,g=e.getLevelsByField,x=e.endDate;return(0,a.jsxs)("div",{id:"pollution-map-overlay",className:"map-overlay",children:[(0,a.jsxs)("div",{className:"map-overlay-control map-legend",children:[(0,a.jsx)("div",{style:{fontWeight:"bold"},children:null==f?void 0:f.fieldName}),null==f?void 0:f.ranges.map(function(e,t){var n=(0,i._)(e,2),r=n[0],s=n[1];return(0,a.jsxs)("div",{children:[(0,a.jsx)("span",{style:{backgroundColor:f.colors[t]},className:"map-legend-key"}),(0,a.jsxs)("span",{children:["[",r<1?r.toFixed(3):r.toFixed(1),","," ",s<1?s.toFixed(3):s.toFixed(1),")"]})]},"".concat(m,"-").concat(t))})]}),g?(0,a.jsxs)("div",{className:"map-overlay-control map-pollution-range-mode",children:[(0,a.jsx)("h4",{className:"font-bold",children:"Field to map"}),Object.keys(g).map(function(e,t){return(0,a.jsxs)("div",{children:[(0,a.jsx)("input",{type:"radio",name:"field-to-map",onClick:function(){return l(e)},defaultChecked:0===t},e),(0,a.jsx)("label",{htmlFor:"field-to-map",children:" ".concat(e)}),(0,a.jsx)("br",{})]},e)})]}):null,(0,a.jsxs)("div",{className:"map-overlay-control map-pollution-range-mode",children:[(0,a.jsx)("input",{type:"checkbox",checked:m,onChange:function(){return u(!m)}})," ","Dynamic Levels"]}),(0,a.jsxs)("div",{className:"map-overlay-control map-pollution-range-mode",children:[(0,a.jsx)("input",{type:"checkbox",checked:y,onChange:function(){return c(!y)}})," ","After Date",(0,a.jsx)("br",{}),(0,a.jsx)("input",{type:"datetime-local",disabled:!y,value:(0,Q.A)(s,"yyyy-MM-dd'T'HH:mm"),onChange:function(e){var t=new Date(e.currentTarget.value);z(t)&&o(t)}})]}),(0,a.jsxs)("div",{className:"map-overlay-control map-pollution-range-mode",children:[(0,a.jsx)("input",{type:"checkbox",checked:v,onChange:function(){return d(!v)}})," ","End Date",(0,a.jsx)("br",{}),(0,a.jsx)("input",{type:"datetime-local",disabled:!v,value:(0,Q.A)(x,"yyyy-MM-dd'T'HH:mm"),onChange:function(e){var t=new Date(e.currentTarget.value);z(t)&&r(t)}})]}),t===p.Dr?(0,a.jsx)("div",{className:"map-overlay-control map-pollution-range-mode",children:(0,a.jsx)(Z.A,{onClick:function(){n(!h)},children:"Show charts"})}):null]})},et=u()(function(){return n.e(224).then(n.bind(n,14224))},{loadableGenerated:{webpack:function(){return[14224]}}});function en(){v();var e,t=(0,i._)((0,c.useState)(""),2),n=t[0],l=t[1],u=(0,i._)((0,c.useState)(!0),2),m=u[0],y=u[1],x=(0,i._)((0,c.useState)(!1),2),j=x[0],b=x[1],_=(0,i._)((0,c.useState)(V),2),S=_[0],A=_[1],C=(0,i._)((0,c.useState)(!1),2),I=C[0],L=C[1],R=(0,i._)((0,c.useState)(U),2),T=R[0],B=R[1],P=(0,i._)((0,c.useState)(!1),2),H=P[0],O=P[1],J=(0,i._)(c.useState(),2),G=J[0],K=J[1],Q=(0,i._)(c.useState([-122.66155,45.54846]),2),Z=Q[0],z=Q[1],en=(0,h.xw)(),er=en.value,ei=er.urls,es=er.sensorType,eo=(0,N.JS)(es),ea=eo.isLoading,el=eo.error,eu=eo.data,ec=(null==eu?void 0:eu.mapbox)||{},ed=ec.getLevels,ef=ec.getLevelsByField,ep=n?null==ef?void 0:ef[n]:ed,em=(null==eu?void 0:eu.download)||{},eh=em.downloadGeoJSON,ev=em.dateField,ey=(0,f.useQuery)({queryKey:["map","sensor-".concat(es)].concat((0,s._)(ei),[void 0===eh?"undefined":(0,o._)(eh)]),queryFn:function(){var e,t=null===(e=en.value)||void 0===e?void 0:e.luggage;return es===p.Dr&&t?Promise.resolve(t):eh?eh(ei):Promise.resolve({type:"FeatureCollection",features:[]})},cacheTime:1e9}),eg=ey.isLoading,ex=ey.error,ej=ey.data,eb=el||ex,ek=E({unfilteredGeojson:ej,dateField:ev||"",startDate:S,isFilterAfterStart:j,isFilterBeforeEnd:I,endDate:T}),e_=(0,c.useMemo)(function(){return ep&&ek?ep({isMinMaxDynamicRange:m,geojson:ek}):null},[ep,m,ek]);(0,c.useEffect)(function(){if(ek){var e=(0,F.Qk1)(ek);if(e[0]<=-1/0||e[0]>=1/0){console.error("infinity detected. bounds skipped");return}K(e)}},[ek]);var ew=(0,i._)(c.useState(null),2),eD=ew[0],eF=ew[1],eS=function(){return eF(null)},eE=c.useRef(null);M({mapRef:eE,className:"w-full content"}),(0,c.useEffect)(function(){var e=function(e){e.key.match(/esc/i)&&eS()},t=function(e){return eS()},n=(0,i._)(document.getElementsByTagName("canvas")||[],1)[0];return null==n||n.addEventListener("click",t),window.addEventListener("keyup",e),function(){window.removeEventListener("keyup",e),null==n||n.removeEventListener("click",t)}},[eD]);var eN=w({onSelectFeature:c.useCallback(function(e){G&&K(void 0);var t=e.geometry.coordinates;Z&&t&&z(t);var n=(0,r._)({},e);["channels","debug","pocketlabsEntry","pm05EndCol"].forEach(function(e){var t=n.properties;t&&delete t[e]}),eF(e)},[Z,G,eF])});if(eb)return(0,a.jsx)(W,{error:eb,datasource:en});if(ea||eg)return(0,a.jsx)(g,{msg:"Downloading data"});if(!ek)return(0,a.jsx)(g,{msg:"Preparing geojson"});var eM=null==ek?void 0:null===(e=ek.features[0])||void 0===e?void 0:e.properties;return(0,a.jsxs)(k,{children:[(0,a.jsx)(q,{}),(0,a.jsx)(d.T5,{style:{width:"100vw",height:"100%"},onClick:function(e){return $(e,"onClick",eN)},onMouseEnter:function(e){return $(e,"onMouseEnter",eN)},onMouseLeave:function(e){return $(e,"onMouseLeave",eN)},interactiveLayerIds:[eN.layerId],initialViewState:{longitude:Z[0],latitude:Z[1],zoom:12},mapboxAccessToken:"pk.eyJ1IjoicGR4Y2xlYW5haXIiLCJhIjoiY2tweDFuZmxpMjFmbzJ3bXVkajd4dDQ4dSJ9.LYiRB4TgOAckcqZGi-cUXg",mapStyle:"mapbox://styles/pdxcleanair/ckpx7yno443sa17p6iy65qn95",ref:eE,children:(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(D,{id:eN.layerId,geojson:ek,circleCases:null==e_?void 0:e_.circleCases}),eM?void 0:(0,a.jsx)(X,{}),eD?(0,a.jsx)(et,{title:"Measurements",className:"overflow-auto h-96",feature:eD}):null,e_?(0,a.jsx)(ee,{sensorType:es,startDate:S,setEndDate:B,setStartDate:A,setMappingField:l,setIsMinMaxDynamicRange:y,setIsFilteringAfterStart:b,setIsFilterBeforeEnd:L,setIsBottomSheetOpen:O,levels:e_,isMinMaxDynamicRange:m,isFilterBeforeEnd:I,isFilterAfterStart:j,isBottomSheetOpen:H,getLevelsByField:ef,endDate:T}):null]})}),(0,a.jsx)(Y,{isOpen:H,onDismiss:O,geojson:ek})]})}},48747:(e,t,n)=>{"use strict";n.d(t,{A:()=>l});var r=n(34618),i=n(58139),s=n(65723),o=n(70851);n(22155);var a={bg:"bg-gray-600 hover:bg-gray-700 focus:ring-gray-500 focus:ring-offset-gray-200",display:"flex"};let l=function(e){var t=e.styles,n=void 0===t?{}:t,l=n.bg,u=void 0===l?a.bg:l,c=n.display,d=void 0===c?a.display:c,f=e.type,p=e.className,m=(0,i._)(e,["styles","type","className"]),h=(0,o.A)(p,u,d,"py-2 px-4 justify-center items-center text-white transition ease-in duration-200 text-center text-base font-semibold shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 rounded-lg",m.disabled?"bg-gray-400 hover:bg-gray-400 cursor-not-allowed":"");return(0,s.jsx)("button",(0,r._)({type:void 0===f?"button":f,className:h},m))}},22774:(e,t,n)=>{"use strict";n.d(t,{Hf:()=>a,JS:()=>d,jr:()=>u});var r=n(48967),i=n(65959),s=n(29928),o=n(52062),a=function(){return n.e(994).then(n.bind(n,26994)).then(function(e){return e.getResources()})},l=function(){var e;return n.e(881).then(n.bind(n,66881)).then((e=(0,r._)(function(e){return(0,i.YH)(this,function(t){return[2,e.getResources()]})}),function(t){return e.apply(this,arguments)}))},u=function(){var e;return n.e(867).then(n.bind(n,67867)).then((e=(0,r._)(function(e){return(0,i.YH)(this,function(t){return[2,e.getResources()]})}),function(t){return e.apply(this,arguments)}))},c=function(){var e;return n.e(109).then(n.bind(n,38109)).then((e=(0,r._)(function(e){return(0,i.YH)(this,function(t){return[2,e.getResources()]})}),function(t){return e.apply(this,arguments)}))},d=function(e){return(0,s.useQuery)({queryKey:"get-mapping-".concat(e),queryFn:(0,r._)(function(){return(0,i.YH)(this,function(t){switch(t.label){case 0:return[4,e===o.Ke?a():e===o.tH?l():e===o.Dr?u():e===o.cZ?c():function(){throw Error("unsupported sensor type ".concat(e))}()];case 1:return[2,t.sent()]}})}),cacheTime:1e9})}}},e=>{var t=t=>e(e.s=t);e.O(0,[175,216,723,636,593,792],()=>t(54109)),_N_E=e.O()}]);
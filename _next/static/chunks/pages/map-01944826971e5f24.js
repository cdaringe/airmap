(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[890],{54109:(e,n,t)=>{(window.__NEXT_P=window.__NEXT_P||[]).push(["/map",function(){return t(59938)}])},59938:(e,n,t)=>{"use strict";t.r(n),t.d(n,{default:()=>X});var r=t(34618),o=t(12551),s=t(61760),a=t(70573),i=t(65723),l=t(43794),u=t.n(l),c=t(22155),d=t(13578),f=t(29928);t(8188);var p=t(29766),m=t(33925),v=t(521),h=function(e,n){return(e===m.Dr||e===m.cf)&&n},g=function(){var e=(0,v.xw)().value,n=e.luggage,t=e.urls,r=e.sensorType,o=(0,p.useRouter)();(0,c.useEffect)(function(){!h(r,n)&&(!t.length||t.some(function(e){return!e}))&&(console.warn("no datasource detected, routing back to homepage"),o.push("/"))},[t,o,r,n])},y=t(33139);function x(e){var n=e.msg;return(0,i.jsxs)("div",{className:"flex justify-center w-full flex-column content",children:[(0,i.jsx)(y.A,{className:"w-20 animate-spin"}),n?(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)("br",{}),(0,i.jsx)("p",{children:n})]}):null]})}var j=t(88910),b=t(61455),_=t(91249),S=function(e){function n(e){var t;return(0,b._)(this,n),(t=(0,j._)(this,n,[e])).state={error:null},t}return(0,_._)(n,e),n.prototype.render=function(){return this.state.error?(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)("h1",{children:"Something went wrong."}),(0,i.jsx)("pre",{children:this.state.error})]}):this.props.children},n.getDerivedStateFromError=function(e){return{error:String(e)}},n}(c.Component),w={visibility:"visible"},F=function(e){var n=e.onSelectFeature;return c.useMemo(function(){return{layerId:"pollution",onClick:function(e,t){"Point"===t.geometry.type&&n(t)},onMouseEnter:function(e){e.target.getCanvas().style.cursor="pointer"},onMouseLeave:function(e){e.target.getCanvas().style.cursor=""}}},[n])},k=function(e){var n,t=e.id,r=e.geojson,o=e.circleCases;return r?(0,i.jsx)(d.kL,{id:t,type:"geojson",data:r,children:(0,i.jsx)(d.Wd,{id:t,type:"circle",layout:w,paint:(n=void 0===o?[]:o,{"circle-color":["case"].concat((0,s._)(n),["black"]),"circle-radius":5})})}):null},N=t(26237),E=t(92831),D=function(e){var n=e.dateField,t=e.endDate,o=e.isFilterAfterStart,s=e.isFilterBeforeEnd,a=e.startDate,i=e.unfilteredGeojson;return c.useMemo(function(){if(!o&&!s)return i;if(!n)throw Error("sensor type missing dateField column name");var e=null==i?void 0:i.features;return e?(0,E._)((0,r._)({},i),{features:e.filter(function(e){var r=new Date(e.properties[n]);return(!o||!(r<=a))&&(!s||!(r>=t))})}):i},[n,t,o,s,a,i])},M=t(22774),C=function(e){var n=e.mapRef,t=e.className,r=(0,o._)(c.useState(0),2),s=r[0],a=r[1],i=c.useMemo(function(){return setInterval(function(){a(function(e){return e+1})},50)},[]),l=n.current;c.useEffect(function(){if(l){clearInterval(i);var e=l.getContainer();e.className.includes(t)||(e.className+=" "+t)}},[i,l,t,s])},A=t(67597),R=t.n(A);function I(){return(0,i.jsx)(R(),{children:(0,i.jsx)("link",{href:"https://api.mapbox.com/mapbox-gl-js/v3.9.3/mapbox-gl.css",rel:"stylesheet"})},"mapboxstyle")}function L(e){var n=e.error,t=e.datasource;return(0,i.jsxs)("div",{className:"p-2",children:[(0,i.jsx)("h1",{children:"Error"}),(0,i.jsx)("h2",{children:"Failed to load map data."}),(0,i.jsx)("p",{children:"string"==typeof n?n:(0,i.jsx)("pre",{children:JSON.stringify(n,null,2)})}),(0,i.jsxs)("p",{children:["Are you sure your datasource is correct?",(0,i.jsx)("pre",{children:JSON.stringify(t,null,2)})]})]})}function T(){return(0,i.jsx)("p",{className:"p-2",children:"The datafile provided could not be converted into geojson format. Generally, this occurs because the columns in the data sheet do not match the expected field names."})}var B=t(974),O=t(48747),G=function(e){return!e.toString().match(/Invalid/)},Y=new Date("2020-01-01"),H=new Date("".concat(new Date().getFullYear(),"-12-31")),J=function(e,n){for(var t,r=arguments.length,o=Array(r>2?r-2:0),s=2;s<r;s++)o[s-2]=arguments[s];return null===(t=e.features)||void 0===t?void 0:t.forEach(function(t){return o.forEach(function(r){var o;null===(o=r[n])||void 0===o||o.call(r,e,t)})})},P=function(e){var n,t=e.sensorType,r=e.setIsBottomSheetOpen,s=e.setEndDate,a=e.startDate,l=e.setStartDate,u=e.setMappingField,c=e.setIsMinMaxDynamicRange,d=e.setIsFilteringAfterStart,f=e.setIsFilterBeforeEnd,p=e.levels,v=e.isMinMaxDynamicRange,h=e.isBottomSheetOpen,g=e.isFilterBeforeEnd,y=e.isFilterAfterStart,x=e.getLevelsByField,j=e.endDate,b=e.setCountForceRerender,_=null!==(n=m.mY[t])&&void 0!==n?n:"Unknown Sensor";return(0,i.jsxs)("div",{id:"pollution-map-overlay",className:"map-overlay",children:[(0,i.jsxs)("div",{className:"map-overlay-control map-legend",children:["Sensor: ",_]}),(0,i.jsxs)("div",{className:"map-overlay-control map-legend",children:[(0,i.jsx)("div",{style:{fontWeight:"bold"},children:null==p?void 0:p.fieldName}),null==p?void 0:p.ranges.map(function(e,n){var t=(0,o._)(e,2),r=t[0],s=t[1];return(0,i.jsxs)("div",{children:[(0,i.jsx)("span",{style:{backgroundColor:p.colors[n]},className:"map-legend-key"}),(0,i.jsxs)("span",{children:["[",r<1?r.toFixed(3):r.toFixed(1),","," ",s<1?s.toFixed(3):s.toFixed(1),")"]})]},"".concat(v,"-").concat(n))})]}),x?(0,i.jsxs)("div",{className:"map-overlay-control map-pollution-range-mode",children:[(0,i.jsx)("h4",{className:"font-bold",children:"Field to map"}),Object.keys(x).map(function(e,n){return(0,i.jsxs)("div",{children:[(0,i.jsx)("input",{type:"radio",name:"field-to-map",onClick:function(){return u(e)},defaultChecked:0===n},e),(0,i.jsx)("label",{htmlFor:"field-to-map",children:" ".concat(e)}),(0,i.jsx)("br",{})]},e)})]}):null,(0,i.jsxs)("div",{className:"map-overlay-control map-pollution-range-mode",children:[(0,i.jsx)("input",{type:"checkbox",checked:v,onChange:function(){return c(!v)}})," ","Dynamic Levels"]}),(0,i.jsxs)("div",{className:"map-overlay-control map-pollution-range-mode",children:[(0,i.jsx)("input",{type:"checkbox",checked:y,onChange:function(){return d(!y)}})," ","After Date",(0,i.jsx)("br",{}),(0,i.jsx)("input",{type:"datetime-local",disabled:!y,value:(0,B.A)(a,"yyyy-MM-dd'T'HH:mm"),onChange:function(e){var n=new Date(e.currentTarget.value);G(n)&&l(n)}})]}),(0,i.jsxs)("div",{className:"map-overlay-control map-pollution-range-mode",children:[(0,i.jsx)("input",{type:"checkbox",checked:g,onChange:function(){return f(!g)}})," ","End Date",(0,i.jsx)("br",{}),(0,i.jsx)("input",{type:"datetime-local",disabled:!g,value:(0,B.A)(j,"yyyy-MM-dd'T'HH:mm"),onChange:function(e){var n=new Date(e.currentTarget.value);G(n)&&s(n)}})]}),t===m.Dr||t===m.cf?(0,i.jsx)("div",{className:"map-overlay-control map-pollution-range-mode",children:(0,i.jsx)(O.A,{onClick:function(){r(!h)},children:"Show charts"})}):null,t===m.cf?(0,i.jsxs)("div",{className:"map-overlay-control map-pollution-range-mode",children:[(0,i.jsx)("label",{htmlFor:"isoscalar",children:"Isobutylene scalar"}),":",(0,i.jsx)("input",{id:"isoscalar",className:"ml-1",type:"input",defaultValue:1,onChange:function(e){var n=Number(e.currentTarget.value);Number.isFinite(n)&&(window.__AEROQUAL_S500_SCALAR__=n,b(function(e){return e+1}))}})]}):null]})},q=u()(function(){return Promise.all([t.e(991),t.e(996)]).then(t.bind(t,15996)).then(function(e){return e.MapBottomSheet})},{loadableGenerated:{webpack:function(){return[15996]}},ssr:!1}),Q=u()(function(){return t.e(224).then(t.bind(t,14224))},{loadableGenerated:{webpack:function(){return[14224]}},ssr:!1});function X(){g();var e,n=(0,o._)((0,c.useState)(""),2),t=n[0],l=n[1],u=(0,o._)((0,c.useState)(!0),2),p=u[0],m=u[1],y=(0,o._)((0,c.useState)(!1),2),j=y[0],b=y[1],_=(0,o._)((0,c.useState)(Y),2),w=_[0],E=_[1],A=(0,o._)((0,c.useState)(!1),2),R=A[0],B=A[1],O=(0,o._)((0,c.useState)(H),2),G=O[0],X=O[1],K=(0,o._)((0,c.useState)(!1),2),W=K[0],U=K[1],V=(0,o._)(c.useState(),2),Z=V[0],z=V[1],$=(0,o._)(c.useState([-122.66155,45.54846]),2),ee=$[0],en=$[1],et=(0,o._)(c.useState(0),2),er=et[0],eo=et[1],es=(0,v.xw)(),ea=es.value,ei=ea.urls,el=ea.sensorType,eu=(0,M.useSensorMappingResources)(el),ec=eu.isLoading,ed=eu.error,ef=eu.data,ep=ef||{},em=ep.mapbox,ev=void 0===em?{}:em,eh=ev.getLevels,eg=ev.getLevelsByField,ey=ep.processGeoJSONMemoKey,ex=ep.processGeoJSON,ej=t?null==eg?void 0:eg[t]:eh,eb=(null==ef?void 0:ef.download)||{},e_=eb.downloadGeoJSON,eS=eb.dateField,ew=(0,f.useQuery)({queryKey:["map","sensor-".concat(el)].concat((0,s._)(ei),[void 0===e_?"undefined":(0,a._)(e_)]),queryFn:function(){var e,n=null===(e=es.value)||void 0===e?void 0:e.luggage;return n&&h(el,n)?Promise.resolve(n):e_?e_(ei):Promise.resolve({type:"FeatureCollection",features:[]})},cacheTime:1e9}),eF=ew.isLoading,ek=ew.error,eN=ew.data,eE=ed||ek,eD=D({unfilteredGeojson:eN,dateField:eS||"",startDate:w,isFilterAfterStart:j,isFilterBeforeEnd:R,endDate:G}),eM=(0,c.useMemo)(function(){return ej&&eD?ej({isMinMaxDynamicRange:p,geojson:eD}):null},[ej,p,eD]);(0,c.useEffect)(function(){if(eD){var e=(0,N.Qk1)(eD);if(e[0]<=-1/0||e[0]>=1/0){console.error("infinity detected. bounds skipped");return}z(e)}},[eD]);var eC=(0,o._)(c.useState(null),2),eA=eC[0],eR=eC[1],eI=function(){return eR(null)},eL=c.useRef(null);C({mapRef:eL,className:"w-full content"}),(0,c.useEffect)(function(){var e=function(e){e.key.match(/esc/i)&&eI()},n=function(e){return eI()},t=(0,o._)(document.getElementsByTagName("canvas")||[],1)[0];return null==t||t.addEventListener("click",n),window.addEventListener("keyup",e),function(){window.removeEventListener("keyup",e),null==t||t.removeEventListener("click",n)}},[eA]);var eT=F({onSelectFeature:c.useCallback(function(e){Z&&z(void 0);var n=e.geometry.coordinates;ee&&n&&en(n);var t=(0,r._)({},e);["channels","debug","pocketlabsEntry","pm05EndCol"].forEach(function(e){var n=t.properties;n&&delete n[e]}),eR(e)},[ee,Z,eR])}),eB=c.useMemo(function(){return eD&&ex?ex(eD):eD},[eD,null==ey?void 0:ey(),er]);if(eE)return(0,i.jsx)(L,{error:eE,datasource:es});if(ec||eF)return(0,i.jsx)(x,{msg:"Downloading data"});if(!eB)return(0,i.jsx)(x,{msg:"Preparing geojson"});var eO=null==eB?void 0:null===(e=eB.features[0])||void 0===e?void 0:e.properties;return(0,i.jsxs)(S,{children:[(0,i.jsx)(I,{}),(0,i.jsx)(d.T5,{style:{width:"100vw",height:"100%"},onClick:function(e){return J(e,"onClick",eT)},onMouseEnter:function(e){return J(e,"onMouseEnter",eT)},onMouseLeave:function(e){return J(e,"onMouseLeave",eT)},interactiveLayerIds:[eT.layerId],initialViewState:{longitude:ee[0],latitude:ee[1],zoom:12},mapboxAccessToken:"pk.eyJ1IjoicGR4Y2xlYW5haXIiLCJhIjoiY2tweDFuZmxpMjFmbzJ3bXVkajd4dDQ4dSJ9.LYiRB4TgOAckcqZGi-cUXg",mapStyle:"mapbox://styles/pdxcleanair/ckpx7yno443sa17p6iy65qn95",ref:eL,children:(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(k,{id:eT.layerId,geojson:eB,circleCases:null==eM?void 0:eM.circleCases}),eO?void 0:(0,i.jsx)(T,{}),eA?(0,i.jsx)(Q,{title:"Measurements",className:"overflow-auto h-96",feature:eA}):null,eM?(0,i.jsx)(P,{sensorType:el,startDate:w,setEndDate:X,setStartDate:E,setMappingField:l,setIsMinMaxDynamicRange:m,setIsFilteringAfterStart:b,setCountForceRerender:eo,setIsFilterBeforeEnd:B,setIsBottomSheetOpen:U,levels:eM,isMinMaxDynamicRange:p,isFilterBeforeEnd:R,isFilterAfterStart:j,isBottomSheetOpen:W,getLevelsByField:eg,endDate:G}):null]})}),W?(0,i.jsx)(q,{isOpen:W,onDismiss:U,geojson:eB,sensorId:el}):null]})}},48747:(e,n,t)=>{"use strict";t.d(n,{A:()=>l});var r=t(34618),o=t(58139),s=t(65723),a=t(70851);t(22155);var i={bg:"bg-gray-600 hover:bg-gray-700 focus:ring-gray-500 focus:ring-offset-gray-200",display:"flex"};let l=function(e){var n=e.styles,t=void 0===n?{}:n,l=t.bg,u=void 0===l?i.bg:l,c=t.display,d=void 0===c?i.display:c,f=e.type,p=e.className,m=(0,o._)(e,["styles","type","className"]),v=(0,a.A)(p,u,d,"py-2 px-4 justify-center items-center text-white transition ease-in duration-200 text-center text-base font-semibold shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 rounded-lg",m.disabled?"bg-gray-400 hover:bg-gray-400 cursor-not-allowed":"");return(0,s.jsx)("button",(0,r._)({type:void 0===f?"button":f,className:v},m))}},22774:(e,n,t)=>{"use strict";t.r(n),t.d(n,{getAeroqualS5000:()=>d,getAirmapGps:()=>c,getFlow:()=>l,getMiniWras:()=>u,getPocket:()=>i,useSensorMappingResources:()=>f});var r=t(48967),o=t(65959),s=t(29928),a=t(33925),i=function(){return t.e(994).then(t.bind(t,26994)).then(function(e){return e.getResources()})},l=function(){var e;return t.e(881).then(t.bind(t,66881)).then((e=(0,r._)(function(e){return(0,o.YH)(this,function(n){return[2,e.getResources()]})}),function(n){return e.apply(this,arguments)}))},u=function(){var e;return t.e(867).then(t.bind(t,67867)).then((e=(0,r._)(function(e){return(0,o.YH)(this,function(n){return[2,e.getResources()]})}),function(n){return e.apply(this,arguments)}))},c=function(){var e;return t.e(109).then(t.bind(t,38109)).then((e=(0,r._)(function(e){return(0,o.YH)(this,function(n){return[2,e.getResources()]})}),function(n){return e.apply(this,arguments)}))},d=function(){var e;return t.e(12).then(t.bind(t,11012)).then((e=(0,r._)(function(e){return(0,o.YH)(this,function(n){return[2,e.getResources()]})}),function(n){return e.apply(this,arguments)}))},f=function(e){return(0,s.useQuery)({queryKey:"get-mapping-".concat(e),queryFn:(0,r._)(function(){return(0,o.YH)(this,function(n){switch(n.label){case 0:return[4,e===a.Ke?i():e===a.tH?l():e===a.Dr?u():e===a.cZ?c():e===a.cf?d():function(){throw Error("unsupported sensor type ".concat(e))}()];case 1:return[2,n.sent()]}})}),cacheTime:1e9})}}},e=>{var n=n=>e(e.s=n);e.O(0,[175,681,636,593,792],()=>n(54109)),_N_E=e.O()}]);
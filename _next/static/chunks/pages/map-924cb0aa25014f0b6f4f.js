(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[538],{8397:function(e,t,r){"use strict";r.r(t),r.d(t,{default:function(){return R}});var n=r(4637),i=r(1384),c=r(307),o=r(1691),s=r(9496),a=r(5262),u=r(8626),l=r(419),p=r(2205),f=r.n(p),d=r(606),h=r(9206),m=function(e){return fetch(e,{mode:"cors",redirect:"follow",headers:{accept:"text"}}).then((function(e){return e.text()}))},v=function(e,t){return.0534*e-.0844*t+5.604},x=function(e){return new Promise((function(t,r){return(0,h.csv2geojson)(e,{latfield:"Latitude",lonfield:"Longitude",delimiter:","},(function(e,n){return e?r(e):t(n)}))}))},g=function(){var e=(0,d.Z)(f().mark((function e(t){var r,n,i,c;return f().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=new URL(t),(n=new URLSearchParams(r.search)).has("tqx")||n.set("tqx","out:csv"),n.has("sheet")||n.set("sheet","data"),r.search=n.toString(),e.next=7,m(r.toString());case 7:return i=e.sent,e.next=10,x(i.replace(new RegExp("&#179;","g"),"^3").replace(new RegExp("&#x2082;","g"),"\u2082").replace(new RegExp("&#x2083;","g"),"\u2083").replace(new RegExp("&#x2103;","g"),"\u2103"));case 10:return(c=e.sent).features.forEach((function(e){var t=e.properties;if(!t)throw new Error("missing properties");var r=t["Particulate Matter-PM2.5 (ug/m^3)"],n=t["Particulate Matter-PM1.0 (ug/m^3)"],i=t["Humidity-Humidity (%RH)"],c=parseInt(r),o=parseInt(n),s=parseFloat(i);t["PM2.5"]=c.toPrecision(3),t.PM1=o.toPrecision(3),t["PM2.5 Corrected"]=v(c,s).toPrecision(3),t["PM1 Corrected"]=v(o,s).toPrecision(3)})),e.abrupt("return",c);case 13:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),y=r(9552),b=r(6817),w=r(4942),j=r(7254);function P(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}var O=(0,b.default)((function(){return r.e(171).then(r.bind(r,1171))}),{loadableGenerated:{webpack:function(){return[1171]},modules:["../src/components/pages/map.tsx -> ../MeasurementPopup"]}}),k=function(e,t){return{url:"api.mapbox.com"===e.slice(8,22)||"tiles.mapbox.com"===e.slice(10,26)?e.replace("?","?pluginName=sheetMapper&"):e}},E={visibility:"visible"},M={"circle-color":"purple","circle-radius":5};function R(){var e=(0,l.wl)().value.url,t=(0,u.useQuery)({queryKey:["map-csv"],queryFn:function(){return g(e)}}),r=t.isLoading,p=t.error,f=t.data,d=(0,w.useRouter)();s.useEffect((function(){return(e?void 0:d.push("/"))&&void 0}),[e,d]);var h=s.useState(),m=(0,c.Z)(h,2),v=m[0],x=m[1];s.useEffect((function(){if(f){var e=(0,y.VWR)(f);e[0]<=-1/0||e[0]>=1/0?console.error("infitity detected. bounds skipped"):x(e)}}),[f]);var b=s.useRef((0,a.ZP)({accessToken:"pk.eyJ1IjoicGR4Y2xlYW5haXIiLCJhIjoiY2tweDFuZmxpMjFmbzJ3bXVkajd4dDQ4dSJ9.LYiRB4TgOAckcqZGi-cUXg",transformRequest:k})).current,R=s.useState(null),N=(0,c.Z)(R,2),C=N[0],_=N[1],S=s.useCallback((function(){return _(null)}),[_]);if(p)return(0,n.jsxs)("div",{children:[(0,n.jsx)("h1",{children:"Error"}),(0,n.jsx)("p",{children:"string"===typeof p?p:JSON.stringify(p,null,2)})]});var L=f?(0,n.jsx)(a.Wy,function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?P(Object(r),!0).forEach((function(t){(0,i.Z)(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):P(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}({},{id:"pm25Corrected",data:f,circleLayout:E,circlePaint:M,circleOnClick:function(e){var t=e.target.queryRenderedFeatures(e.point),r=(0,c.Z)(t,1)[0];"Point"===(null===r||void 0===r?void 0:r.geometry.type)?_(r):console.error("no feature found under pointer :thinking:",r)},circleOnMouseEnter:function(e){e.target.getCanvas().style.cursor="pointer"},circleOnMouseLeave:function(e){e.target.getCanvas().style.cursor=""}})):void 0;return 0===(null===f||void 0===f?void 0:f.features.length)?(0,n.jsxs)("div",{className:"p-4",children:[(0,n.jsx)("h1",{className:"text-xl",children:"Missing data"}),(0,n.jsx)("p",{children:"The data has been downloaded, but is empty :/"})]}):r?(0,n.jsx)("div",{className:"flex flex-column w-full content justify-center",children:(0,n.jsx)(j.Z,{className:"animate-spin w-20"})}):(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(o.default,{children:(0,n.jsx)("link",{href:"https://api.mapbox.com/mapbox-gl-js/v2.3.1/mapbox-gl.css",rel:"stylesheet"})}),(0,n.jsxs)(b,{className:"content w-full",fitBounds:v,center:[-122.66155,45.54846],style:"mapbox://styles/pdxcleanair/ckpx7yno443sa17p6iy65qn95",containerStyle:{height:"100%",width:"100vw"},onClick:function(){S()},children:[L,C?(0,n.jsx)(O,{title:"Measurements",className:"h-96 overflow-auto",feature:C,onClick:function(e){e.preventDefault()}}):void 0]})]})}},9590:function(e,t,r){(window.__NEXT_P=window.__NEXT_P||[]).push(["/map",function(){return r(8397)}])}},function(e){e.O(0,[275,485,163,888,179],(function(){return t=9590,e(e.s=t);var t}));var t=e.O();_N_E=t}]);
(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[538],{3126:function(e,n,t){(window.__NEXT_P=window.__NEXT_P||[]).push(["/map",function(){return t(1689)}])},1689:function(e,n,t){"use strict";t.r(n),t.d(n,{default:function(){return z}});var r=t(1250),o=t(797),a=t(9901),i=t(9162),c=t(2168),s=t(8507),u=t(9235);function l(){return(0,r.jsx)("div",{className:"flex flex-column w-full content justify-center",children:(0,r.jsx)(u.Z,{className:"animate-spin w-20"})})}function d(e,n){return function(e){if(Array.isArray(e))return e}(e)||function(e,n){var t=[],r=!0,o=!1,a=void 0;try{for(var i,c=e[Symbol.iterator]();!(r=(i=c.next()).done)&&(t.push(i.value),!n||t.length!==n);r=!0);}catch(s){o=!0,a=s}finally{try{r||null==c.return||c.return()}finally{if(o)throw a}}return t}(e,n)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}function f(e){return function(e){if(Array.isArray(e)){for(var n=0,t=new Array(e.length);n<e.length;n++)t[n]=e[n];return t}}(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}var p={visibility:"visible"},v=function(e){var n,t=e.geojson,o=e.onSelectFeature,c=e.circleCases,s=void 0===c?[]:c,u=a.useCallback((function(e){e.preventDefault();var n=d(e.target.queryRenderedFeatures(e.point),1)[0];"Point"===(null===n||void 0===n?void 0:n.geometry.type)?o(n):console.error("no feature found under pointer :thinking:",n)}),[o]),l=a.useCallback((function(e){e.target.getCanvas().style.cursor="pointer"}),[]),v=a.useCallback((function(e){e.target.getCanvas().style.cursor=""}),[]);return(0,r.jsx)(i.Wy,{data:t,circleLayout:p,circlePaint:(n=s,{"circle-color":["case"].concat(f(n),["black"]),"circle-radius":5}),circleOnClick:u,circleOnMouseEnter:l,circleOnMouseLeave:v})},m=t(2106),y=t(4221),h=t(4235),x=t.n(h),g=t(1371);function j(e,n,t,r,o,a,i){try{var c=e[a](i),s=c.value}catch(u){return void t(u)}c.done?n(s):Promise.resolve(s).then(r,o)}function b(e){return function(){var n=this,t=arguments;return new Promise((function(r,o){var a=e.apply(n,t);function i(e){j(a,r,o,i,c,"next",e)}function c(e){j(a,r,o,i,c,"throw",e)}i(void 0)}))}}function w(e){var n=e.error,t=e.datasource;return(0,r.jsxs)("div",{className:"p-2",children:[(0,r.jsx)("h1",{children:"Error"}),(0,r.jsx)("h2",{children:"Failed to load map data."}),(0,r.jsx)("p",{children:"string"===typeof n?n:(0,r.jsx)("pre",{children:JSON.stringify(n,null,2)})}),(0,r.jsxs)("p",{children:["Are you sure your datasource is correct?",(0,r.jsx)("pre",{children:JSON.stringify(t,null,2)})]})]})}function k(){return(0,r.jsx)("p",{className:"p-2",children:"The datafile provided could not be converted into geojson format. Generally, this occurs because the columns in the data sheet do not match the expected field names."})}var S=t(8832);function E(){return(0,r.jsx)(S.default,{children:(0,r.jsx)("link",{href:"https://api.mapbox.com/mapbox-gl-js/v2.3.1/mapbox-gl.css",rel:"stylesheet"})})}var A=t(9277);function N(e,n,t,r,o,a,i){try{var c=e[a](i),s=c.value}catch(u){return void t(u)}c.done?n(s):Promise.resolve(s).then(r,o)}function D(e){return function(){var n=this,t=arguments;return new Promise((function(r,o){var a=e.apply(n,t);function i(e){N(a,r,o,i,c,"next",e)}function c(e){N(a,r,o,i,c,"throw",e)}i(void 0)}))}}function C(e){return O.apply(this,arguments)}function O(){return(O=D(x().mark((function e(n){return x().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n.addControl(new A.Ex,"bottom-right"),n.addControl(new A.Ly,"bottom-right"),n.addControl(new A.jP,"bottom-right");case 3:case"end":return e.stop()}}),e)})))).apply(this,arguments)}var P=t(5087);function T(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}var F=function(e){var n=e.dateField,t=e.endDate,r=e.isFilterAfterStart,o=e.isFilterBeforeEnd,i=e.startDate,c=e.unfilteredGeojson;return a.useMemo((function(){if(!r&&!o)return c;if(!n)throw new Error("sensor type missing dateField column name");var e=null===c||void 0===c?void 0:c.features;return e?function(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{},r=Object.keys(t);"function"===typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(t).filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})))),r.forEach((function(n){T(e,n,t[n])}))}return e}({},c,{features:e.filter((function(e){var a=new Date(e.properties[n]);return!(r&&a<=i)&&!(o&&a>=t)}))}):c}),[n,t,r,o,i,c])},M=t(2573),L=(t(8641),t(1268)),R=t(9922),_=t(4657),I=t(7839),q=t(2462),B=t(2242),G=t(2220),J=t(4531),K=function(e){var n=e.geojson;return(0,r.jsx)(L.h,{aspect:3,width:"100%",children:(0,r.jsxs)(R.w,{data:n.features,margin:{top:5,right:30,left:20,bottom:5},children:[(0,r.jsx)(_.q,{strokeDasharray:"3 3"}),(0,r.jsx)(I.K,{dataKey:"name"}),(0,r.jsx)(q.B,{yAxisId:"left"}),(0,r.jsx)(q.B,{yAxisId:"right",orientation:"right"}),(0,r.jsx)(B.u,{}),(0,r.jsx)(G.D,{}),(0,r.jsx)(J.x,{yAxisId:"left",type:"monotone",dataKey:function(e){return e.properties.pm_2_3},name:"PM2.5 (MW)",stroke:"#8884d8",activeDot:{r:8}}),(0,r.jsx)(J.x,{yAxisId:"left",type:"monotone",dataKey:function(e){return e.properties.pocketlabsEntry.pm_2_5},name:"PM2.5 (PL)",stroke:"#6684d8",activeDot:{r:8}}),(0,r.jsx)(J.x,{yAxisId:"right",type:"monotone",dataKey:function(e){return e.properties.pocketlabsEntry.humidity},name:"Humidity (PL)",stroke:"#82ca9d"})]})})};function H(e,n){return function(e){if(Array.isArray(e))return e}(e)||function(e,n){var t=[],r=!0,o=!1,a=void 0;try{for(var i,c=e[Symbol.iterator]();!(r=(i=c.next()).done)&&(t.push(i.value),!n||t.length!==n);r=!0);}catch(s){o=!0,a=s}finally{try{r||null==c.return||c.return()}finally{if(o)throw a}}return t}(e,n)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}function W(e){return function(e){if(Array.isArray(e)){for(var n=0,t=new Array(e.length);n<e.length;n++)t[n]=e[n];return t}}(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}var Z=function(e){return!e.toString().match(/Invalid/)},X=(0,s.default)((function(){return t.e(525).then(t.bind(t,405))}),{loadableGenerated:{webpack:function(){return[405]},modules:["../src/components/pages/map/index.tsx -> ../../MeasurementPopup"]}}),Y=function(e,n){return{url:"api.mapbox.com"===e.slice(8,22)||"tiles.mapbox.com"===e.slice(10,26)?e.replace("?","?pluginName=sheetMapper&"):e}},Q=new Date("2020-01-01"),V=new Date("".concat((new Date).getFullYear(),"-12-31"));function z(){var e,n=(0,a.useState)(!0),s=n[0],u=n[1],d=(0,a.useState)(!1),f=d[0],p=d[1],h=(0,a.useState)(Q),j=h[0],S=h[1],A=(0,a.useState)(!1),N=A[0],D=A[1],O=(0,a.useState)(V),T=O[0],L=O[1],R=(0,a.useState)(!1),_=R[0],I=R[1];!function(){var e=(0,c.wl)().value.urls,n=(0,y.useRouter)();(0,a.useEffect)((function(){return(!e.length||e.some((function(e){return!e}))?n.push("/"):void 0)&&void 0}),[e,n])}();var q,B=H(a.useState(),2),G=B[0],J=B[1],z=H(a.useState([-122.66155,45.54846]),2),U=z[0],$=z[1],ee=(0,c.wl)(),ne=ee.value,te=ne.urls,re=ne.sensorType,oe=function(e){return(0,g.useQuery)({queryKey:"get-mapping-".concat(e),queryFn:b(x().mark((function n(){var r;return x().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,e===o.p4?t.e(855).then(t.bind(t,855)).then((function(e){return e.getResources()})):e===o.OS?t.e(848).then(t.bind(t,7848)).then(b(x().mark((function e(n){var r;return x().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.e(358).then(t.bind(t,358));case 2:return r=e.sent.closestTo,e.abrupt("return",n.getResources({closestTo:r}));case 4:case"end":return e.stop()}}),e)})))):e===o.R3?t.e(422).then(t.bind(t,6422)).then(b(x().mark((function e(n){var r;return x().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.e(358).then(t.bind(t,358));case 2:return r=e.sent.closestTo,e.abrupt("return",n.getResources({closestTo:r}));case 4:case"end":return e.stop()}}),e)})))):function(){throw new Error("unsupported sensor type ".concat(e))}();case 2:return r=n.sent,n.abrupt("return",r);case 4:case"end":return n.stop()}}),n)}))),cacheTime:1e9})}(re),ae=oe.isLoading,ie=oe.error,ce=oe.data,se=void 0===ce?{mapbox:{},download:{}}:ce,ue=se.download,le=se.mapbox.getLevels,de=ue.downloadGeoJSON,fe=ue.dateField,pe=(0,g.useQuery)({queryKey:["map","sensor-".concat(re)].concat(W(te),["undefined"===typeof de?"undefined":(q=de,q&&"undefined"!==typeof Symbol&&q.constructor===Symbol?"symbol":typeof q)]),queryFn:function(){return null===de||void 0===de?void 0:de(te)},cacheTime:1e9}),ve=pe.isLoading,me=pe.error,ye=pe.data,he=ie||me,xe=ae||ve,ge=F({unfilteredGeojson:ye,dateField:fe||"",startDate:j,isFilterAfterStart:f,isFilterBeforeEnd:N,endDate:T}),je=(0,a.useMemo)((function(){return le&&ge?le({isMinMaxDynamicRange:s,geojson:ge}):null}),[le,s,ge]);!function(e,n){(0,a.useEffect)((function(){if(e){var t=(0,m.VWR)(e);t[0]<=-1/0||t[0]>=1/0?console.error("infitity detected. bounds skipped"):n(t)}}),[e])}(ge,J);var be=a.useRef((0,i.ZP)({accessToken:"pk.eyJ1IjoicGR4Y2xlYW5haXIiLCJhIjoiY2tweDFuZmxpMjFmbzJ3bXVkajd4dDQ4dSJ9.LYiRB4TgOAckcqZGi-cUXg",transformRequest:Y})).current,we=H(a.useState(null),2),ke=we[0],Se=we[1],Ee=function(){return Se(null)};if((0,a.useEffect)((function(){var e=function(e){e.key.match(/esc/i)&&Ee()},n=function(e){return Ee()},t=H(document.getElementsByTagName("canvas")||[],1)[0];return null===t||void 0===t||t.addEventListener("click",n),window.addEventListener("keyup",e),function(){window.removeEventListener("keyup",e),null===t||void 0===t||t.removeEventListener("click",n)}}),[ke]),he)return(0,r.jsx)(w,{error:he,datasource:ee});if(xe)return(0,r.jsx)(l,{});var Ae=null===(e=null===ge||void 0===ge?void 0:ge.features[0])||void 0===e?void 0:e.properties;return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(E,{}),(0,r.jsxs)(be,{onStyleLoad:C,className:"w-full content",fitBounds:G,center:U,style:"mapbox://styles/pdxcleanair/ckpx7yno443sa17p6iy65qn95",containerStyle:{height:"100%",width:"100vw"},children:[Ae?void 0:(0,r.jsx)(k,{}),ge&&(0,r.jsx)(v,{geojson:ge,circleCases:null===je||void 0===je?void 0:je.circleCases,onSelectFeature:function(e){G&&J(void 0),U&&$(e.geometry.coordinates),Se(e)}}),ke?(0,r.jsx)(X,{title:"Measurements",className:"overflow-auto h-96",feature:ke,onClick:function(e){e.preventDefault()}}):void 0,(0,r.jsxs)("div",{className:"map-overlay",children:[(0,r.jsxs)("div",{className:"map-overlay-control map-legend",children:[(0,r.jsx)("div",{style:{fontWeight:"bold"},children:null===je||void 0===je?void 0:je.fieldName}),null===je||void 0===je?void 0:je.pm2Ranges.map((function(e,n){var t=H(e,2),o=t[0],a=t[1];return(0,r.jsxs)("div",{children:[(0,r.jsx)("span",{style:{backgroundColor:je.colors[n]},className:"map-legend-key"}),(0,r.jsxs)("span",{children:["[",o.toFixed(1),", ",a.toFixed(1),")"]})]},"".concat(s,"-").concat(n))}))]}),(0,r.jsxs)("div",{className:"map-overlay-control map-pollution-range-mode",children:[(0,r.jsx)("input",{type:"checkbox",checked:s,onChange:function(){return u(!s)}})," ","Dynamic Levels"]}),(0,r.jsxs)("div",{className:"map-overlay-control map-pollution-range-mode",children:[(0,r.jsx)("input",{type:"checkbox",checked:f,onChange:function(){return p(!f)}})," ","After Date",(0,r.jsx)("br",{}),(0,r.jsx)("input",{type:"datetime-local",disabled:!f,value:(0,P.Z)(j,"yyyy-MM-dd'T'HH:mm"),onChange:function(e){var n=new Date(e.currentTarget.value);Z(n)&&S(n)}})]}),(0,r.jsxs)("div",{className:"map-overlay-control map-pollution-range-mode",children:[(0,r.jsx)("input",{type:"checkbox",checked:N,onChange:function(){return D(!N)}})," ","End Date",(0,r.jsx)("br",{}),(0,r.jsx)("input",{type:"datetime-local",disabled:!N,value:(0,P.Z)(T,"yyyy-MM-dd'T'HH:mm"),onChange:function(e){var n=new Date(e.currentTarget.value);Z(n)&&L(n)}})]}),re===o.R3?(0,r.jsxs)("div",{className:"map-overlay-control map-pollution-range-mode",children:[(0,r.jsx)("input",{type:"checkbox",checked:_,onChange:function(){return I(!_)}})," ","Show charts",(0,r.jsx)("br",{})]}):null]})]}),(0,r.jsx)(M.R,{blocking:!1,open:_,onDismiss:function(){return I(!1)},children:(0,r.jsxs)("div",{className:"p-4",children:[(0,r.jsx)("h3",{children:"PM2.5 & Humidity - MiniWRAS & PocketLabs"}),(0,r.jsx)(K,{geojson:ge})]})})]})}}},function(e){e.O(0,[774,138,406,573,124,888,179],(function(){return n=3126,e(e.s=n);var n}));var n=e.O();_N_E=n}]);
(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[890],{54109:(e,t,n)=>{(window.__NEXT_P=window.__NEXT_P||[]).push(["/map",function(){return n(84377)}])},84377:(e,t,n)=>{"use strict";n.r(t),n.d(t,{default:()=>er});var r=n(34618),o=n(12551),i=n(61760),s=n(70573),a=n(65723),l=n(43794),u=n.n(l),c=n(22155),d=n(13578),f=n(29928);n(8188);var p=n(29766),m=n(33925),v=n(521),h=function(e,t){return(e===m.Dr||e===m.cf)&&t},g=function(){var e=(0,v.xw)().value,t=e.luggage,n=e.urls,r=e.sensorType,o=(0,p.useRouter)();(0,c.useEffect)(function(){!h(r,t)&&(!n.length||n.some(function(e){return!e}))&&(console.warn("no datasource detected, routing back to homepage"),o.push("/"))},[n,o,r,t])},y=n(33139);function x(e){var t=e.msg;return(0,a.jsxs)("div",{className:"flex justify-center w-full flex-column content",children:[(0,a.jsx)(y.A,{className:"w-20 animate-spin"}),t?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("br",{}),(0,a.jsx)("p",{children:t})]}):null]})}var j=n(88910),b=n(61455),_=n(91249),k=function(e){function t(e){var n;return(0,b._)(this,t),(n=(0,j._)(this,t,[e])).state={error:null},n}return(0,_._)(t,e),t.prototype.render=function(){return this.state.error?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("h1",{children:"Something went wrong."}),(0,a.jsx)("pre",{children:this.state.error})]}):this.props.children},t.getDerivedStateFromError=function(e){return{error:String(e)}},t}(c.Component),S={visibility:"visible"},w=function(e){var t=e.onSelectFeature;return c.useMemo(function(){return{layerId:"pollution",onClick:function(e,n){"Point"===n.geometry.type&&t(n)},onMouseEnter:function(e){e.target.getCanvas().style.cursor="pointer"},onMouseLeave:function(e){e.target.getCanvas().style.cursor=""}}},[t])},F=function(e){var t,n=e.id,r=e.geojson,o=e.circleCases;return r?(0,a.jsx)(d.kL,{id:n,type:"geojson",data:r,children:(0,a.jsx)(d.Wd,{id:n,type:"circle",layout:S,paint:(t=void 0===o?[]:o,{"circle-color":["case"].concat((0,i._)(t),["black"]),"circle-radius":5})})}):null},N=n(26237),D=n(92831),E=function(e){var t=e.dateField,n=e.endDate,o=e.isFilterAfterStart,i=e.isFilterBeforeEnd,s=e.startDate,a=e.unfilteredGeojson;return c.useMemo(function(){if(!o&&!i)return a;if(!t)throw Error("sensor type missing dateField column name");var e=null==a?void 0:a.features;return e?(0,D._)((0,r._)({},a),{features:e.filter(function(e){var r=new Date(e.properties[t]);return(!o||!(r<=s))&&(!i||!(r>=n))})}):a},[t,n,o,i,s,a])},M=n(22774),A=function(e){var t=e.mapRef,n=e.className,r=(0,o._)(c.useState(0),2),i=r[0],s=r[1],a=c.useMemo(function(){return setInterval(function(){s(function(e){return e+1})},50)},[]),l=t.current;c.useEffect(function(){if(l){clearInterval(a);var e=l.getContainer();e.className.includes(n)||(e.className+=" "+n)}},[a,l,n,i])},C=n(84991),L=n(17917),R=n(52425),I=n(63587),T=n(62448),O=n(89591),B=n(60330),P=n(23724),H=n(18258),J=n(79895),Y=function(e){var t,n=e.geojson;return(null===(t=n.features[0])||void 0===t?void 0:t.properties.pocketlabsEntry)?(0,a.jsx)(L.u,{aspect:3,width:"100%",children:(0,a.jsxs)(R.b,{data:n.features,margin:{top:5,right:30,left:20,bottom:5},children:[(0,a.jsx)(I.d,{strokeDasharray:"3 3"}),(0,a.jsx)(T.W,{dataKey:"name",label:"Time"}),(0,a.jsx)(O.h,{yAxisId:"left",children:(0,a.jsx)(B.J,{angle:-90,value:"ug/m3",position:"insideLeft",style:{textAnchor:"middle"}})}),(0,a.jsx)(O.h,{yAxisId:"right",orientation:"right",children:(0,a.jsx)(B.J,{angle:90,value:"Relative Humidity %",position:"insideRight",style:{textAnchor:"middle"}})}),(0,a.jsx)(P.m,{}),(0,a.jsx)(H.s,{wrapperStyle:{marginLeft:10},align:"right",verticalAlign:"middle",layout:"vertical"}),(0,a.jsx)(J.N,{yAxisId:"left",type:"monotone",dataKey:function(e){return e.properties.pm_2_5},name:"PM2.5 (MW)",stroke:"red",activeDot:{r:8}}),(0,a.jsx)(J.N,{yAxisId:"left",type:"monotone",dataKey:function(e){var t,n;return null!==(n=null===(t=e.properties.pocketlabsEntry)||void 0===t?void 0:t.pm_2_5)&&void 0!==n?n:0},name:"PM2.5 (PL)",stroke:"blue",activeDot:{r:8}}),(0,a.jsx)(J.N,{yAxisId:"right",type:"monotone",dataKey:function(e){var t,n;return null!==(n=null===(t=e.properties.pocketlabsEntry)||void 0===t?void 0:t.humidity)&&void 0!==n?n:0},name:"Humidity (PL)",stroke:"lightslategray"})]})}):(0,a.jsx)("p",{children:"Pocketlabs data is missing. Please upload a pocket labs file."})},G=function(e){var t=e.isOpen,n=e.onDismiss,r=e.geojson;return(0,a.jsx)(C.X,{blocking:!1,open:t,onDismiss:function(){return n(!1)},children:(0,a.jsxs)("div",{className:"p-4",children:[(0,a.jsx)("h3",{children:"PM2.5 & Humidity - MiniWRAS & PocketLabs"}),(0,a.jsx)(Y,{geojson:r})]})})},K=n(67597),q=n.n(K);function W(){return(0,a.jsx)(q(),{children:(0,a.jsx)("link",{href:"https://api.mapbox.com/mapbox-gl-js/v3.9.3/mapbox-gl.css",rel:"stylesheet"})},"mapboxstyle")}function X(e){var t=e.error,n=e.datasource;return(0,a.jsxs)("div",{className:"p-2",children:[(0,a.jsx)("h1",{children:"Error"}),(0,a.jsx)("h2",{children:"Failed to load map data."}),(0,a.jsx)("p",{children:"string"==typeof t?t:(0,a.jsx)("pre",{children:JSON.stringify(t,null,2)})}),(0,a.jsxs)("p",{children:["Are you sure your datasource is correct?",(0,a.jsx)("pre",{children:JSON.stringify(n,null,2)})]})]})}function Q(){return(0,a.jsx)("p",{className:"p-2",children:"The datafile provided could not be converted into geojson format. Generally, this occurs because the columns in the data sheet do not match the expected field names."})}var U=n(974),V=n(48747),Z=function(e){return!e.toString().match(/Invalid/)},z=new Date("2020-01-01"),$=new Date("".concat(new Date().getFullYear(),"-12-31")),ee=function(e,t){for(var n,r=arguments.length,o=Array(r>2?r-2:0),i=2;i<r;i++)o[i-2]=arguments[i];return null===(n=e.features)||void 0===n?void 0:n.forEach(function(n){return o.forEach(function(r){var o;null===(o=r[t])||void 0===o||o.call(r,e,n)})})},et=function(e){var t,n=e.sensorType,r=e.setIsBottomSheetOpen,i=e.setEndDate,s=e.startDate,l=e.setStartDate,u=e.setMappingField,c=e.setIsMinMaxDynamicRange,d=e.setIsFilteringAfterStart,f=e.setIsFilterBeforeEnd,p=e.levels,v=e.isMinMaxDynamicRange,h=e.isBottomSheetOpen,g=e.isFilterBeforeEnd,y=e.isFilterAfterStart,x=e.getLevelsByField,j=e.endDate,b=e.setCountForceRerender,_=null!==(t=m.mY[n])&&void 0!==t?t:"Unknown Sensor";return(0,a.jsxs)("div",{id:"pollution-map-overlay",className:"map-overlay",children:[(0,a.jsxs)("div",{className:"map-overlay-control map-legend",children:["Sensor: ",_]}),(0,a.jsxs)("div",{className:"map-overlay-control map-legend",children:[(0,a.jsx)("div",{style:{fontWeight:"bold"},children:null==p?void 0:p.fieldName}),null==p?void 0:p.ranges.map(function(e,t){var n=(0,o._)(e,2),r=n[0],i=n[1];return(0,a.jsxs)("div",{children:[(0,a.jsx)("span",{style:{backgroundColor:p.colors[t]},className:"map-legend-key"}),(0,a.jsxs)("span",{children:["[",r<1?r.toFixed(3):r.toFixed(1),","," ",i<1?i.toFixed(3):i.toFixed(1),")"]})]},"".concat(v,"-").concat(t))})]}),x?(0,a.jsxs)("div",{className:"map-overlay-control map-pollution-range-mode",children:[(0,a.jsx)("h4",{className:"font-bold",children:"Field to map"}),Object.keys(x).map(function(e,t){return(0,a.jsxs)("div",{children:[(0,a.jsx)("input",{type:"radio",name:"field-to-map",onClick:function(){return u(e)},defaultChecked:0===t},e),(0,a.jsx)("label",{htmlFor:"field-to-map",children:" ".concat(e)}),(0,a.jsx)("br",{})]},e)})]}):null,(0,a.jsxs)("div",{className:"map-overlay-control map-pollution-range-mode",children:[(0,a.jsx)("input",{type:"checkbox",checked:v,onChange:function(){return c(!v)}})," ","Dynamic Levels"]}),(0,a.jsxs)("div",{className:"map-overlay-control map-pollution-range-mode",children:[(0,a.jsx)("input",{type:"checkbox",checked:y,onChange:function(){return d(!y)}})," ","After Date",(0,a.jsx)("br",{}),(0,a.jsx)("input",{type:"datetime-local",disabled:!y,value:(0,U.A)(s,"yyyy-MM-dd'T'HH:mm"),onChange:function(e){var t=new Date(e.currentTarget.value);Z(t)&&l(t)}})]}),(0,a.jsxs)("div",{className:"map-overlay-control map-pollution-range-mode",children:[(0,a.jsx)("input",{type:"checkbox",checked:g,onChange:function(){return f(!g)}})," ","End Date",(0,a.jsx)("br",{}),(0,a.jsx)("input",{type:"datetime-local",disabled:!g,value:(0,U.A)(j,"yyyy-MM-dd'T'HH:mm"),onChange:function(e){var t=new Date(e.currentTarget.value);Z(t)&&i(t)}})]}),n===m.Dr?(0,a.jsx)("div",{className:"map-overlay-control map-pollution-range-mode",children:(0,a.jsx)(V.A,{onClick:function(){r(!h)},children:"Show charts"})}):null,n===m.cf?(0,a.jsxs)("div",{className:"map-overlay-control map-pollution-range-mode",children:[(0,a.jsx)("label",{htmlFor:"isoscalar",children:"Isobutylene scalar"}),":",(0,a.jsx)("input",{id:"isoscalar",className:"ml-1",type:"input",defaultValue:1,onChange:function(e){var t=Number(e.currentTarget.value);Number.isFinite(t)&&(window.__AEROQUAL_S500_SCALAR__=t,b(function(e){return e+1}))}})]}):null]})},en=u()(function(){return n.e(224).then(n.bind(n,14224))},{loadableGenerated:{webpack:function(){return[14224]}}});function er(){g();var e,t=(0,o._)((0,c.useState)(""),2),n=t[0],l=t[1],u=(0,o._)((0,c.useState)(!0),2),p=u[0],m=u[1],y=(0,o._)((0,c.useState)(!1),2),j=y[0],b=y[1],_=(0,o._)((0,c.useState)(z),2),S=_[0],D=_[1],C=(0,o._)((0,c.useState)(!1),2),L=C[0],R=C[1],I=(0,o._)((0,c.useState)($),2),T=I[0],O=I[1],B=(0,o._)((0,c.useState)(!1),2),P=B[0],H=B[1],J=(0,o._)(c.useState(),2),Y=J[0],K=J[1],q=(0,o._)(c.useState([-122.66155,45.54846]),2),U=q[0],V=q[1],Z=(0,o._)(c.useState(0),2),er=Z[0],eo=Z[1],ei=(0,v.xw)(),es=ei.value,ea=es.urls,el=es.sensorType,eu=(0,M.useSensorMappingResources)(el),ec=eu.isLoading,ed=eu.error,ef=eu.data,ep=ef||{},em=ep.mapbox,ev=void 0===em?{}:em,eh=ev.getLevels,eg=ev.getLevelsByField,ey=ep.processGeoJSONMemoKey,ex=ep.processGeoJSON,ej=n?null==eg?void 0:eg[n]:eh,eb=(null==ef?void 0:ef.download)||{},e_=eb.downloadGeoJSON,ek=eb.dateField,eS=(0,f.useQuery)({queryKey:["map","sensor-".concat(el)].concat((0,i._)(ea),[void 0===e_?"undefined":(0,s._)(e_)]),queryFn:function(){var e,t=null===(e=ei.value)||void 0===e?void 0:e.luggage;return t&&h(el,t)?Promise.resolve(t):e_?e_(ea):Promise.resolve({type:"FeatureCollection",features:[]})},cacheTime:1e9}),ew=eS.isLoading,eF=eS.error,eN=eS.data,eD=ed||eF,eE=E({unfilteredGeojson:eN,dateField:ek||"",startDate:S,isFilterAfterStart:j,isFilterBeforeEnd:L,endDate:T}),eM=(0,c.useMemo)(function(){return ej&&eE?ej({isMinMaxDynamicRange:p,geojson:eE}):null},[ej,p,eE]);(0,c.useEffect)(function(){if(eE){var e=(0,N.Qk1)(eE);if(e[0]<=-1/0||e[0]>=1/0){console.error("infinity detected. bounds skipped");return}K(e)}},[eE]);var eA=(0,o._)(c.useState(null),2),eC=eA[0],eL=eA[1],eR=function(){return eL(null)},eI=c.useRef(null);A({mapRef:eI,className:"w-full content"}),(0,c.useEffect)(function(){var e=function(e){e.key.match(/esc/i)&&eR()},t=function(e){return eR()},n=(0,o._)(document.getElementsByTagName("canvas")||[],1)[0];return null==n||n.addEventListener("click",t),window.addEventListener("keyup",e),function(){window.removeEventListener("keyup",e),null==n||n.removeEventListener("click",t)}},[eC]);var eT=w({onSelectFeature:c.useCallback(function(e){Y&&K(void 0);var t=e.geometry.coordinates;U&&t&&V(t);var n=(0,r._)({},e);["channels","debug","pocketlabsEntry","pm05EndCol"].forEach(function(e){var t=n.properties;t&&delete t[e]}),eL(e)},[U,Y,eL])}),eO=c.useMemo(function(){return eE&&ex?ex(eE):eE},[eE,null==ey?void 0:ey(),er]);if(eD)return(0,a.jsx)(X,{error:eD,datasource:ei});if(ec||ew)return(0,a.jsx)(x,{msg:"Downloading data"});if(!eO)return(0,a.jsx)(x,{msg:"Preparing geojson"});var eB=null==eO?void 0:null===(e=eO.features[0])||void 0===e?void 0:e.properties;return(0,a.jsxs)(k,{children:[(0,a.jsx)(W,{}),(0,a.jsx)(d.T5,{style:{width:"100vw",height:"100%"},onClick:function(e){return ee(e,"onClick",eT)},onMouseEnter:function(e){return ee(e,"onMouseEnter",eT)},onMouseLeave:function(e){return ee(e,"onMouseLeave",eT)},interactiveLayerIds:[eT.layerId],initialViewState:{longitude:U[0],latitude:U[1],zoom:12},mapboxAccessToken:"pk.eyJ1IjoicGR4Y2xlYW5haXIiLCJhIjoiY2tweDFuZmxpMjFmbzJ3bXVkajd4dDQ4dSJ9.LYiRB4TgOAckcqZGi-cUXg",mapStyle:"mapbox://styles/pdxcleanair/ckpx7yno443sa17p6iy65qn95",ref:eI,children:(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(F,{id:eT.layerId,geojson:eO,circleCases:null==eM?void 0:eM.circleCases}),eB?void 0:(0,a.jsx)(Q,{}),eC?(0,a.jsx)(en,{title:"Measurements",className:"overflow-auto h-96",feature:eC}):null,eM?(0,a.jsx)(et,{sensorType:el,startDate:S,setEndDate:O,setStartDate:D,setMappingField:l,setIsMinMaxDynamicRange:m,setIsFilteringAfterStart:b,setCountForceRerender:eo,setIsFilterBeforeEnd:R,setIsBottomSheetOpen:H,levels:eM,isMinMaxDynamicRange:p,isFilterBeforeEnd:L,isFilterAfterStart:j,isBottomSheetOpen:P,getLevelsByField:eg,endDate:T}):null]})}),(0,a.jsx)(G,{isOpen:P,onDismiss:H,geojson:eO})]})}},48747:(e,t,n)=>{"use strict";n.d(t,{A:()=>l});var r=n(34618),o=n(58139),i=n(65723),s=n(70851);n(22155);var a={bg:"bg-gray-600 hover:bg-gray-700 focus:ring-gray-500 focus:ring-offset-gray-200",display:"flex"};let l=function(e){var t=e.styles,n=void 0===t?{}:t,l=n.bg,u=void 0===l?a.bg:l,c=n.display,d=void 0===c?a.display:c,f=e.type,p=e.className,m=(0,o._)(e,["styles","type","className"]),v=(0,s.A)(p,u,d,"py-2 px-4 justify-center items-center text-white transition ease-in duration-200 text-center text-base font-semibold shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 rounded-lg",m.disabled?"bg-gray-400 hover:bg-gray-400 cursor-not-allowed":"");return(0,i.jsx)("button",(0,r._)({type:void 0===f?"button":f,className:v},m))}},22774:(e,t,n)=>{"use strict";n.r(t),n.d(t,{getAeroqualS5000:()=>d,getAirmapGps:()=>c,getFlow:()=>l,getMiniWras:()=>u,getPocket:()=>a,useSensorMappingResources:()=>f});var r=n(48967),o=n(65959),i=n(29928),s=n(33925),a=function(){return n.e(994).then(n.bind(n,26994)).then(function(e){return e.getResources()})},l=function(){var e;return n.e(881).then(n.bind(n,66881)).then((e=(0,r._)(function(e){return(0,o.YH)(this,function(t){return[2,e.getResources()]})}),function(t){return e.apply(this,arguments)}))},u=function(){var e;return n.e(867).then(n.bind(n,67867)).then((e=(0,r._)(function(e){return(0,o.YH)(this,function(t){return[2,e.getResources()]})}),function(t){return e.apply(this,arguments)}))},c=function(){var e;return n.e(109).then(n.bind(n,38109)).then((e=(0,r._)(function(e){return(0,o.YH)(this,function(t){return[2,e.getResources()]})}),function(t){return e.apply(this,arguments)}))},d=function(){var e;return n.e(12).then(n.bind(n,11012)).then((e=(0,r._)(function(e){return(0,o.YH)(this,function(t){return[2,e.getResources()]})}),function(t){return e.apply(this,arguments)}))},f=function(e){return(0,i.useQuery)({queryKey:"get-mapping-".concat(e),queryFn:(0,r._)(function(){return(0,o.YH)(this,function(t){switch(t.label){case 0:return[4,e===s.Ke?a():e===s.tH?l():e===s.Dr?u():e===s.cZ?c():e===s.cf?d():function(){throw Error("unsupported sensor type ".concat(e))}()];case 1:return[2,t.sent()]}})}),cacheTime:1e9})}}},e=>{var t=t=>e(e.s=t);e.O(0,[175,756,407,636,593,792],()=>t(54109)),_N_E=e.O()}]);
(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[538],{3126:function(e,t,n){(window.__NEXT_P=window.__NEXT_P||[]).push(["/map",function(){return n(1689)}])},1689:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return $}});var r=n(1250),o=n(797),i=n(9901),a=n(9162),s=n(2168),c=n(8507),u=n(9235);function l(){return(0,r.jsx)("div",{className:"flex flex-column w-full content justify-center",children:(0,r.jsx)(u.Z,{className:"animate-spin w-20"})})}function d(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=[],r=!0,o=!1,i=void 0;try{for(var a,s=e[Symbol.iterator]();!(r=(a=s.next()).done)&&(n.push(a.value),!t||n.length!==t);r=!0);}catch(c){o=!0,i=c}finally{try{r||null==s.return||s.return()}finally{if(o)throw i}}return n}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}function f(e){return function(e){if(Array.isArray(e)){for(var t=0,n=new Array(e.length);t<e.length;t++)n[t]=e[t];return n}}(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}var p={visibility:"visible"},y=function(e){var t,n=e.geojson,o=e.onSelectFeature,s=e.circleCases,c=void 0===s?[]:s,u=i.useCallback((function(e){e.preventDefault();var t=d(e.target.queryRenderedFeatures(e.point),1)[0];"Point"===(null===t||void 0===t?void 0:t.geometry.type)?o(t):console.error("no feature found under pointer :thinking:",t)}),[o]),l=i.useCallback((function(e){e.target.getCanvas().style.cursor="pointer"}),[]),y=i.useCallback((function(e){e.target.getCanvas().style.cursor=""}),[]);return(0,r.jsx)(a.Wy,{data:n,circleLayout:p,circlePaint:(t=c,{"circle-color":["case"].concat(f(t),["black"]),"circle-radius":5}),circleOnClick:u,circleOnMouseEnter:l,circleOnMouseLeave:y})},m=n(2106),v=n(4221),h=n(4235),g=n.n(h),x=n(1371);function b(e,t,n,r,o,i,a){try{var s=e[i](a),c=s.value}catch(u){return void n(u)}s.done?t(c):Promise.resolve(c).then(r,o)}function j(e){return function(){var t=this,n=arguments;return new Promise((function(r,o){var i=e.apply(t,n);function a(e){b(i,r,o,a,s,"next",e)}function s(e){b(i,r,o,a,s,"throw",e)}a(void 0)}))}}function w(e){var t=e.error,n=e.datasource;return(0,r.jsxs)("div",{className:"p-2",children:[(0,r.jsx)("h1",{children:"Error"}),(0,r.jsx)("h2",{children:"Failed to load map data."}),(0,r.jsx)("p",{children:"string"===typeof t?t:(0,r.jsx)("pre",{children:JSON.stringify(t,null,2)})}),(0,r.jsxs)("p",{children:["Are you sure your datasource is correct?",(0,r.jsx)("pre",{children:JSON.stringify(n,null,2)})]})]})}function k(){return(0,r.jsx)("p",{className:"p-2",children:"The datafile provided could not be converted into geojson format. Generally, this occurs because the columns in the data sheet do not match the expected field names."})}var O=n(8832);function S(){return(0,r.jsx)(O.default,{children:(0,r.jsx)("link",{href:"https://api.mapbox.com/mapbox-gl-js/v2.3.1/mapbox-gl.css",rel:"stylesheet"})})}var E=n(9277);function N(e,t,n,r,o,i,a){try{var s=e[i](a),c=s.value}catch(u){return void n(u)}s.done?t(c):Promise.resolve(c).then(r,o)}function A(e){return function(){var t=this,n=arguments;return new Promise((function(r,o){var i=e.apply(t,n);function a(e){N(i,r,o,a,s,"next",e)}function s(e){N(i,r,o,a,s,"throw",e)}a(void 0)}))}}function P(e){return D.apply(this,arguments)}function D(){return(D=A(g().mark((function e(t){return g().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t.addControl(new E.Ex,"bottom-right"),t.addControl(new E.Ly,"bottom-right"),t.addControl(new E.jP,"bottom-right");case 3:case"end":return e.stop()}}),e)})))).apply(this,arguments)}var C=n(9944),F=n(5087);function T(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var L=function(e){var t=e.dateField,n=e.endDate,r=e.isFilterAfterStart,o=e.isFilterBeforeEnd,a=e.startDate,s=e.unfilteredGeojson;return i.useMemo((function(){if(!r&&!o)return s;if(!t)throw new Error("sensor type missing dateField column name");var e=null===s||void 0===s?void 0:s.features;return e?function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},r=Object.keys(n);"function"===typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),r.forEach((function(t){T(e,t,n[t])}))}return e}({},s,{features:e.filter((function(e){var i=new Date(e.properties[t]);return!(r&&i<=a)&&!(o&&i>=n)}))}):s}),[t,n,r,o,a,s])},M=n(2573),_=(n(8641),n(1268)),R=n(9922),I=n(4657),q=n(7839),Z=n(2462),B=n(511),G=n(2242),H=n(2220),J=n(4531),K=function(e){var t=e.geojson;return(0,r.jsx)(_.h,{aspect:3,width:"100%",children:(0,r.jsxs)(R.w,{data:t.features,margin:{top:5,right:30,left:20,bottom:5},children:[(0,r.jsx)(I.q,{strokeDasharray:"3 3"}),(0,r.jsx)(q.K,{dataKey:"name",label:"Time"}),(0,r.jsx)(Z.B,{yAxisId:"left",children:(0,r.jsx)(B._,{angle:-90,value:"ug/m3",position:"insideLeft",style:{textAnchor:"middle"}})}),(0,r.jsx)(Z.B,{yAxisId:"right",orientation:"right",children:(0,r.jsx)(B._,{angle:90,value:"Relative Humidity %",position:"insideRight",style:{textAnchor:"middle"}})}),(0,r.jsx)(G.u,{}),(0,r.jsx)(H.D,{wrapperStyle:{marginLeft:10},align:"right",verticalAlign:"middle",layout:"vertical"}),(0,r.jsx)(J.x,{yAxisId:"left",type:"monotone",dataKey:function(e){return e.properties.pm_2_5},name:"PM2.5 (MW)",stroke:"#8884d8",activeDot:{r:8}}),(0,r.jsx)(J.x,{yAxisId:"left",type:"monotone",dataKey:function(e){return e.properties.pocketlabsEntry.pm_2_5},name:"PM2.5 (PL)",stroke:"#6684d8",activeDot:{r:8}}),(0,r.jsx)(J.x,{yAxisId:"right",type:"monotone",dataKey:function(e){return e.properties.pocketlabsEntry.humidity},name:"Humidity (PL)",stroke:"#82ca9d"})]})})};function W(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=[],r=!0,o=!1,i=void 0;try{for(var a,s=e[Symbol.iterator]();!(r=(a=s.next()).done)&&(n.push(a.value),!t||n.length!==t);r=!0);}catch(c){o=!0,i=c}finally{try{r||null==s.return||s.return()}finally{if(o)throw i}}return n}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}function X(e){return function(e){if(Array.isArray(e)){for(var t=0,n=new Array(e.length);t<e.length;t++)n[t]=e[t];return n}}(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}var Y=function(e){return!e.toString().match(/Invalid/)},Q=(0,c.default)((function(){return n.e(525).then(n.bind(n,405))}),{loadableGenerated:{webpack:function(){return[405]},modules:["../src/components/pages/map/index.tsx -> ../../MeasurementPopup"]}}),V=function(e,t){return{url:"api.mapbox.com"===e.slice(8,22)||"tiles.mapbox.com"===e.slice(10,26)?e.replace("?","?pluginName=sheetMapper&"):e}},z=new Date("2020-01-01"),U=new Date("".concat((new Date).getFullYear(),"-12-31"));function $(){var e;!function(){var e=(0,s.wl)().value.urls,t=(0,v.useRouter)();(0,i.useEffect)((function(){return(!e.length||e.some((function(e){return!e}))?t.push("/"):void 0)&&void 0}),[e,t])}();var t,c=(0,i.useState)(""),u=c[0],d=c[1],f=(0,i.useState)(!0),p=f[0],h=f[1],b=(0,i.useState)(!1),O=b[0],E=b[1],N=(0,i.useState)(z),A=N[0],D=N[1],T=(0,i.useState)(!1),_=T[0],R=T[1],I=(0,i.useState)(U),q=I[0],Z=I[1],B=(0,i.useState)(!1),G=B[0],H=B[1],J=W(i.useState(),2),$=J[0],ee=J[1],te=W(i.useState([-122.66155,45.54846]),2),ne=te[0],re=te[1],oe=(0,s.wl)(),ie=oe.value,ae=ie.urls,se=ie.sensorType,ce=function(e){return(0,x.useQuery)({queryKey:"get-mapping-".concat(e),queryFn:j(g().mark((function t(){var r;return g().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,e===o.p4?n.e(855).then(n.bind(n,855)).then((function(e){return e.getResources()})):e===o.OS?n.e(848).then(n.bind(n,7848)).then(j(g().mark((function e(t){var r;return g().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n.e(358).then(n.bind(n,358));case 2:return r=e.sent.closestTo,e.abrupt("return",t.getResources({closestTo:r}));case 4:case"end":return e.stop()}}),e)})))):e===o.R3?n.e(422).then(n.bind(n,6422)).then(j(g().mark((function e(t){var r;return g().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n.e(358).then(n.bind(n,358));case 2:return r=e.sent.closestTo,e.abrupt("return",t.getResources({closestTo:r}));case 4:case"end":return e.stop()}}),e)})))):function(){throw new Error("unsupported sensor type ".concat(e))}();case 2:return r=t.sent,t.abrupt("return",r);case 4:case"end":return t.stop()}}),t)}))),cacheTime:1e9})}(se),ue=ce.isLoading,le=ce.error,de=ce.data,fe=void 0===de?{mapbox:{},download:{}}:de,pe=fe.download,ye=fe.mapbox,me=ye.getLevels,ve=ye.getLevelsByField,he=u?ve[u]:me,ge=pe.downloadGeoJSON,xe=pe.dateField,be=(0,x.useQuery)({queryKey:["map","sensor-".concat(se)].concat(X(ae),["undefined"===typeof ge?"undefined":(t=ge,t&&"undefined"!==typeof Symbol&&t.constructor===Symbol?"symbol":typeof t)]),queryFn:function(){return null===ge||void 0===ge?void 0:ge(ae)},cacheTime:1e9}),je=be.isLoading,we=be.error,ke=be.data,Oe=le||we,Se=ue||je,Ee=L({unfilteredGeojson:ke,dateField:xe||"",startDate:A,isFilterAfterStart:O,isFilterBeforeEnd:_,endDate:q}),Ne=(0,i.useMemo)((function(){return he&&Ee?he({isMinMaxDynamicRange:p,geojson:Ee}):null}),[he,p,Ee]);!function(e,t){(0,i.useEffect)((function(){if(e){var n=(0,m.VWR)(e);n[0]<=-1/0||n[0]>=1/0?console.error("infitity detected. bounds skipped"):t(n)}}),[e])}(Ee,ee);var Ae=i.useRef((0,a.ZP)({accessToken:"pk.eyJ1IjoicGR4Y2xlYW5haXIiLCJhIjoiY2tweDFuZmxpMjFmbzJ3bXVkajd4dDQ4dSJ9.LYiRB4TgOAckcqZGi-cUXg",transformRequest:V})).current,Pe=W(i.useState(null),2),De=Pe[0],Ce=Pe[1],Fe=function(){return Ce(null)};if((0,i.useEffect)((function(){var e=function(e){e.key.match(/esc/i)&&Fe()},t=function(e){return Fe()},n=W(document.getElementsByTagName("canvas")||[],1)[0];return null===n||void 0===n||n.addEventListener("click",t),window.addEventListener("keyup",e),function(){window.removeEventListener("keyup",e),null===n||void 0===n||n.removeEventListener("click",t)}}),[De]),Oe)return(0,r.jsx)(w,{error:Oe,datasource:oe});if(Se)return(0,r.jsx)(l,{});var Te=null===(e=null===Ee||void 0===Ee?void 0:Ee.features[0])||void 0===e?void 0:e.properties;return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(S,{}),(0,r.jsxs)(Ae,{onStyleLoad:P,className:"w-full content",fitBounds:$,center:ne,style:"mapbox://styles/pdxcleanair/ckpx7yno443sa17p6iy65qn95",containerStyle:{height:"100%",width:"100vw"},children:[Te?void 0:(0,r.jsx)(k,{}),Ee&&(0,r.jsx)(y,{geojson:Ee,circleCases:null===Ne||void 0===Ne?void 0:Ne.circleCases,onSelectFeature:function(e){$&&ee(void 0),ne&&re(e.geometry.coordinates),Ce(e)}}),De?(0,r.jsx)(Q,{title:"Measurements",className:"overflow-auto h-96",feature:De,onClick:function(e){e.preventDefault()}}):void 0,(0,r.jsxs)("div",{className:"map-overlay",children:[(0,r.jsxs)("div",{className:"map-overlay-control map-legend",children:[(0,r.jsx)("div",{style:{fontWeight:"bold"},children:null===Ne||void 0===Ne?void 0:Ne.fieldName}),null===Ne||void 0===Ne?void 0:Ne.ranges.map((function(e,t){var n=W(e,2),o=n[0],i=n[1];return(0,r.jsxs)("div",{children:[(0,r.jsx)("span",{style:{backgroundColor:Ne.colors[t]},className:"map-legend-key"}),(0,r.jsxs)("span",{children:["[",o.toFixed(1),", ",i.toFixed(1),")"]})]},"".concat(p,"-").concat(t))}))]}),ve?(0,r.jsxs)("div",{className:"map-overlay-control map-pollution-range-mode",children:[(0,r.jsx)("h4",{className:"font-bold",children:"Field to map"}),Object.keys(ve).map((function(e){return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("input",{type:"radio",name:"field-to-map",onClick:function(){return d(e)}},e),(0,r.jsx)("label",{htmlFor:"field-to-map",children:" ".concat(e)}),(0,r.jsx)("br",{})]})}))]}):null,(0,r.jsxs)("div",{className:"map-overlay-control map-pollution-range-mode",children:[(0,r.jsx)("input",{type:"checkbox",checked:p,onChange:function(){return h(!p)}})," ","Dynamic Levels"]}),(0,r.jsxs)("div",{className:"map-overlay-control map-pollution-range-mode",children:[(0,r.jsx)("input",{type:"checkbox",checked:O,onChange:function(){return E(!O)}})," ","After Date",(0,r.jsx)("br",{}),(0,r.jsx)("input",{type:"datetime-local",disabled:!O,value:(0,F.Z)(A,"yyyy-MM-dd'T'HH:mm"),onChange:function(e){var t=new Date(e.currentTarget.value);Y(t)&&D(t)}})]}),(0,r.jsxs)("div",{className:"map-overlay-control map-pollution-range-mode",children:[(0,r.jsx)("input",{type:"checkbox",checked:_,onChange:function(){return R(!_)}})," ","End Date",(0,r.jsx)("br",{}),(0,r.jsx)("input",{type:"datetime-local",disabled:!_,value:(0,F.Z)(q,"yyyy-MM-dd'T'HH:mm"),onChange:function(e){var t=new Date(e.currentTarget.value);Y(t)&&Z(t)}})]}),se===o.R3?(0,r.jsx)("div",{className:"map-overlay-control map-pollution-range-mode",children:(0,r.jsx)(C.Z,{onClick:function(){return H(!G)},children:"Show charts"})}):null]})]}),(0,r.jsx)(M.R,{blocking:!1,open:G,onDismiss:function(){return H(!1)},children:(0,r.jsxs)("div",{className:"p-4",children:[(0,r.jsx)("h3",{children:"PM2.5 & Humidity - MiniWRAS & PocketLabs"}),(0,r.jsx)(K,{geojson:Ee})]})})]})}},9944:function(e,t,n){"use strict";var r=n(1250),o=n(5789);n(9901);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t){if(null==e)return{};var n,r,o=function(e,t){if(null==e)return{};var n,r,o={},i=Object.keys(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var s="bg-gray-600 hover:bg-gray-700 focus:ring-gray-500 focus:ring-offset-gray-200",c="flex";t.Z=function(e){var t=e.styles,n=void 0===t?{}:t,u=n.bg,l=void 0===u?s:u,d=n.display,f=void 0===d?c:d,p=e.type,y=void 0===p?"button":p,m=e.className,v=a(e,["styles","type","className"]),h=(0,o.Z)(m,l,f,"py-2 px-4 justify-center items-center text-white transition ease-in duration-200 text-center text-base font-semibold shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 rounded-lg",v.disabled?"bg-gray-400 hover:bg-gray-400 cursor-not-allowed":"");return(0,r.jsx)("button",function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},r=Object.keys(n);"function"===typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),r.forEach((function(t){i(e,t,n[t])}))}return e}({type:y,className:h},v))}}},function(e){e.O(0,[774,138,406,573,124,888,179],(function(){return t=3126,e(e.s=t);var t}));var t=e.O();_N_E=t}]);
(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[538],{8779:function(e,t,r){"use strict";r.r(t),r.d(t,{default:function(){return I}});var n=r(4637),o=r(1384),c=r(2205),a=r.n(c),i=r(606),u=r(2468),s=r(1691),l=r(9496),p=r(5262),f=r(8626),d=r(419),m=r(9206),h=function(e){return fetch(e,{mode:"cors",redirect:"follow",headers:{accept:"text"}}).then((function(e){return e.text()}))},v=function(e,t){return.0534*e-.0844*t+5.604},g=function(e){var t=e.startsWith('"Lat"');return new Promise((function(r,n){return(0,m.csv2geojson)(e,{latfield:t?"Lat":"Latitude",lonfield:t?"Lng":"Longitude",delimiter:","},(function(e,t){return e?n(e):r(t)}))}))},b=function(e){return{pm2Str:e["PM2.5 (\xb5g/m\xb3)"],pm1Str:e["PM10 (\xb5g/m\xb3)"],humidityStr:null}},y=function(e){var t=e;return{pm2Str:t["Particulate Matter-PM2.5 (ug/m^3)"],pm1Str:t["Particulate Matter-PM1.0 (ug/m^3)"],humidityStr:t["Humidity-Humidity (%RH)"]}},x=function(){var e=(0,i.Z)(a().mark((function e(t){var r,n,o,c,i;return a().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=new URL(t),(n=new URLSearchParams(r.search)).has("tqx")||n.set("tqx","out:csv"),n.has("sheet")||n.set("sheet","data"),r.search=n.toString(),e.next=7,h(r.toString());case 7:if(!(o=e.sent).startsWith('"VOC')){e.next=15;break}return e.next=11,g(o);case 11:return c=e.sent,e.abrupt("return",c);case 15:return e.next=17,g(o.replace(new RegExp("&#179;","g"),"^3").replace(new RegExp("&#x2082;","g"),"\u2082").replace(new RegExp("&#x2083;","g"),"\u2083").replace(new RegExp("&#x2103;","g"),"\u2103"));case 17:return(i=e.sent).features.forEach((function(e){var t=e.properties;if(!t)throw new Error("missing properties");var r="Mean PM2.5 (\xb5g/m\xb3)"in t?b(t):y(t),n=r.pm2Str,o=r.pm1Str,c=r.humidityStr,a=parseInt(n),i=parseInt(o),u=c?parseFloat(c):null;t["PM2.5"]=a,t.PM1=i,u&&(t["PM2.5 Corrected"]=v(a,u)),u&&(t["PM1 Corrected"]=v(i,u))})),e.abrupt("return",i);case 20:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),j=r(6817),w=r(7254),P=r(3988);function O(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}var M=["get","PM2.5"],C=["#4d0173","#991113","#ff5600","#ffaa00","#feff00","#6fc400","#3aa702"].reverse(),k=[["<=",M,.25],["all",[">",M,.25],["<=",M,.5]],["all",[">",M,.5],["<=",M,1]],["all",[">",M,1],["<=",M,2.5]],["all",[">",M,2.5],["<=",M,5]],["all",[">",M,5],["<=",M,20]],[">",M,20]],S={visibility:"visible"},E={"circle-color":["case"].concat((0,P.Z)(k.flatMap((function(e,t){return[e,C[t]]}))),["black"]),"circle-radius":5},R={"circle-color":["case"].concat((0,P.Z)(k.flatMap((function(e,t){return[e,C[t]]}))),["black"]),"circle-radius":5},Z=function(e){var t,r=e.geojson,c=e.onSelectFeature,a=e.type;t="pm25Corrected"===a?"PM2.5 Corrected":"PM2.5"===a?"PM2.5":a,M[1]=t;var i=l.useCallback((function(e){e.preventDefault();var t=e.target.queryRenderedFeatures(e.point),r=(0,u.Z)(t,1)[0];"Point"===(null===r||void 0===r?void 0:r.geometry.type)?c(r):console.error("no feature found under pointer :thinking:",r)}),[c]),s=l.useCallback((function(e){e.target.getCanvas().style.cursor="pointer"}),[]),f=l.useCallback((function(e){e.target.getCanvas().style.cursor=""}),[]);return(0,n.jsx)(p.Wy,function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?O(Object(r),!0).forEach((function(t){(0,o.Z)(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):O(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}({},{id:"pm25Corrected"===a?"pm25Corrected":"PM2.5"===a?"PM2.5":a,data:r,circleLayout:S,circlePaint:a.startsWith("pm2")?E:R,circleOnClick:i,circleOnMouseEnter:s,circleOnMouseLeave:f}))},L=r(2530),N=r(4942);function D(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function _(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?D(Object(r),!0).forEach((function(t){(0,o.Z)(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):D(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}var q=(0,j.default)((function(){return r.e(171).then(r.bind(r,1171))}),{loadableGenerated:{webpack:function(){return[1171]},modules:["../src/components/pages/map.tsx -> ../MeasurementPopup"]}}),F=function(e,t){return{url:"api.mapbox.com"===e.slice(8,22)||"tiles.mapbox.com"===e.slice(10,26)?e.replace("?","?pluginName=sheetMapper&"):e}};function I(){var e;!function(){var e=(0,d.wl)().value.url,t=(0,N.useRouter)();(0,l.useEffect)((function(){return(e?void 0:t.push("/"))&&void 0}),[e,t])}();var t=(0,d.wl)().value.url,o=(0,f.useQuery)({queryKey:["map-csv"],queryFn:function(){return x(t)}}),c=o.isLoading,m=o.error,h=o.data,v=l.useState(),g=(0,u.Z)(v,2),b=g[0],y=g[1],j=l.useState([-122.66155,45.54846]),P=(0,u.Z)(j,2),O=P[0],M=P[1];!function(e,t){(0,l.useEffect)((function(){if(e){var r=(0,L.VWR)(e);r[0]<=-1/0||r[0]>=1/0?console.error("infitity detected. bounds skipped"):t(r)}}),[e])}(h,y);var C=l.useRef((0,p.ZP)({accessToken:"pk.eyJ1IjoicGR4Y2xlYW5haXIiLCJhIjoiY2tweDFuZmxpMjFmbzJ3bXVkajd4dDQ4dSJ9.LYiRB4TgOAckcqZGi-cUXg",transformRequest:F})).current,k=l.useState(null),S=(0,u.Z)(k,2),E=S[0],R=S[1],D=l.useCallback((function(){return E&&R(null)}),[E,R]);if(m)return(0,n.jsxs)("div",{children:[(0,n.jsx)("h1",{children:"Error"}),(0,n.jsx)("p",{children:"string"===typeof m?m:JSON.stringify(m,null,2)})]});if(c)return(0,n.jsx)("div",{className:"flex flex-column w-full content justify-center",children:(0,n.jsx)(w.Z,{className:"animate-spin w-20"})});var I=null===h||void 0===h||null===(e=h.features[0])||void 0===e?void 0:e.properties,W=I["PM2.5 Corrected"]?"pm25Corrected":I["PM2.5"]?"PM2.5":"voc";return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(s.default,{children:(0,n.jsx)("link",{href:"https://api.mapbox.com/mapbox-gl-js/v2.3.1/mapbox-gl.css",rel:"stylesheet"})}),0===(null===h||void 0===h?void 0:h.features.length)?(0,n.jsxs)("div",{className:"p-4",children:[(0,n.jsx)("h1",{className:"text-xl",children:"Missing data"}),(0,n.jsx)("p",{children:"The data has been downloaded, but is empty :/"})]}):(0,n.jsxs)(C,{onStyleLoad:function(){var e=(0,i.Z)(a().mark((function e(t){var n,o,c,i;return a().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r.e(905).then(r.bind(r,1905));case 2:n=e.sent,o=n.RulerControl,c=n.ZoomControl,n.InspectControl,i=n.StylesControl,t.addControl(new i,"bottom-right"),t.addControl(new c,"bottom-right"),t.addControl(new o,"bottom-right");case 11:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),className:"content w-full",fitBounds:b,center:O,style:"mapbox://styles/pdxcleanair/ckpx7yno443sa17p6iy65qn95",containerStyle:{height:"100%",width:"100vw"},onClick:D,children:[h&&(0,n.jsx)(Z,_({},{geojson:h,type:W,onSelectFeature:function(e){b&&y(void 0),O&&M(e.geometry.coordinates),R(e)}})),E?(0,n.jsx)(q,{title:"Measurements",className:"h-96 overflow-auto",feature:E,onClick:function(e){e.preventDefault()}}):void 0]})]})}},9590:function(e,t,r){(window.__NEXT_P=window.__NEXT_P||[]).push(["/map",function(){return r(8779)}])}},function(e){e.O(0,[275,485,348,888,179],(function(){return t=9590,e(e.s=t);var t}));var t=e.O();_N_E=t}]);
(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[538],{551:function(e,t,r){(window.__NEXT_P=window.__NEXT_P||[]).push(["/map",function(){return r(1749)}])},1749:function(e,t,r){"use strict";r.r(t),r.d(t,{default:function(){return J}});var n=r(7383),o=r.n(n),a=r(4637),i=r(550),u=r(9496),c=r(5918),l=r(8626),s=r(7309),f=r(9206),d=function(e,t){var r=e.match(/[^\r\n]+/g),n=[t],o=[],a=!0,i=!0,u=!1,c=void 0;try{for(var l,s=function(e,r){var i=r.value,u=i[0];if(!u||","===u)return"continue";if("-"===u||u.match(/\d/)){if(a)return"continue";var c=i.split(",");return n.push(o.map((function(e){return c[e]}))),"continue"}var l=i.split(",");o=t.map((function(e){return l.findIndex((function(t){return t===e}))})).filter((function(e){return e>=0})),a=o.length!==t.length},f=r[Symbol.iterator]();!(i=(l=f.next()).done);i=!0)s(0,l)}catch(d){u=!0,c=d}finally{try{i||null==f.return||f.return()}finally{if(u)throw c}}return n};function p(e,t,r,n,o,a,i){try{var u=e[a](i),c=u.value}catch(l){return void r(l)}u.done?t(c):Promise.resolve(c).then(n,o)}var v,h=function(e){return fetch(e,{mode:"cors",redirect:"follow",headers:{accept:"text"}}).then((function(e){return e.text()}))},m=function(e,t){return.0534*e-.0844*t+5.604},y=function(e){return new Promise((function(t,r){return(0,f.csv2geojson)(e,{latfield:"Lat",lonfield:"Lng",delimiter:","},(function(e,n){return e?r(e):t(n)}))}))},g=function(e){return{pm2Str:e["PM2.5 (\xb5g/m\xb3)"],pm1Str:e["PM1.0 (\xb5g/m\xb3)"],humidityStr:null}},x=(v=o().mark((function e(t,r){var n,a,i,u,c;return o().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=new URL(t),(a=new URLSearchParams(n.search)).has("format")||a.set("format","csv"),n.search=a.toString(),e.next=6,h(n.toString());case 6:return i=e.sent,o=d(i,r),u=o.map((function(e){return e.join(",")})).join("\n"),e.next=10,y(u);case 10:return(c=e.sent).features.forEach((function(e){var t=e.properties||{},r=g(t),n=r.pm2Str,o=r.pm1Str,a=r.humidityStr,i=parseInt(n),u=parseInt(o),c=a?parseFloat(a):0;t["PM2.5"]=i,t.PM1=u,c&&(t["PM2.5 Corrected"]=m(i,c)),c&&(t["PM1 Corrected"]=m(u,c))})),e.abrupt("return",c);case 13:case"end":return e.stop()}var o}),e)})),function(){var e=this,t=arguments;return new Promise((function(r,n){var o=v.apply(e,t);function a(e){p(o,r,n,a,i,"next",e)}function i(e){p(o,r,n,a,i,"throw",e)}a(void 0)}))}),w=r(6990),b=r(2388);function j(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var r=[],n=!0,o=!1,a=void 0;try{for(var i,u=e[Symbol.iterator]();!(n=(i=u.next()).done)&&(r.push(i.value),!t||r.length!==t);n=!0);}catch(c){o=!0,a=c}finally{try{n||null==u.return||u.return()}finally{if(o)throw a}}return r}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}function P(e){return function(e){if(Array.isArray(e)){for(var t=0,r=new Array(e.length);t<e.length;t++)r[t]=e[t];return r}}(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}var C=["get","PM2.5"],M=["#4d0173","#991113","#ff5600","#ffaa00","#feff00","#6fc400","#3aa702"].reverse(),S=[["<=",C,.25],["all",[">",C,.25],["<=",C,.5]],["all",[">",C,.5],["<=",C,1]],["all",[">",C,1],["<=",C,2.5]],["all",[">",C,2.5],["<=",C,5]],["all",[">",C,5],["<=",C,20]],[">",C,20]],k={visibility:"visible"},E={"circle-color":["case"].concat(P(S.flatMap((function(e,t){return[e,M[t]]}))),["black"]),"circle-radius":5},N={"circle-color":["case"].concat(P(S.flatMap((function(e,t){return[e,M[t]]}))),["black"]),"circle-radius":5},L=function(e){var t,r=e.geojson,n=e.onSelectFeature,o=e.type;t="pm25Corrected"===o?"PM2.5 Corrected":"PM2.5"===o?"PM2.5":o,C[1]=t;var i=u.useCallback((function(e){e.preventDefault();var t=j(e.target.queryRenderedFeatures(e.point),1)[0];"Point"===(null===t||void 0===t?void 0:t.geometry.type)?n(t):console.error("no feature found under pointer :thinking:",t)}),[n]),l=u.useCallback((function(e){e.target.getCanvas().style.cursor="pointer"}),[]),s=u.useCallback((function(e){e.target.getCanvas().style.cursor=""}),[]);return(0,a.jsx)(c.Wy,{id:"pm25Corrected"===o?"pm25Corrected":"PM2.5"===o?"PM2.5":o,data:r,circleLayout:k,circlePaint:o.startsWith("pm2")?E:N,circleOnClick:i,circleOnMouseEnter:l,circleOnMouseLeave:s})},_=r(1825),A=r(9275);function I(e,t,r,n,o,a,i){try{var u=e[a](i),c=u.value}catch(l){return void r(l)}u.done?t(c):Promise.resolve(c).then(n,o)}function R(e){return function(){var t=this,r=arguments;return new Promise((function(n,o){var a=e.apply(t,r);function i(e){I(a,n,o,i,u,"next",e)}function u(e){I(a,n,o,i,u,"throw",e)}i(void 0)}))}}function O(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var r=[],n=!0,o=!1,a=void 0;try{for(var i,u=e[Symbol.iterator]();!(n=(i=u.next()).done)&&(r.push(i.value),!t||r.length!==t);n=!0);}catch(c){o=!0,a=c}finally{try{n||null==u.return||u.return()}finally{if(o)throw a}}return r}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}var T=(0,w.default)((function(){return r.e(526).then(r.bind(r,7526))}),{loadableGenerated:{webpack:function(){return[7526]},modules:["../src/components/pages/map.tsx -> ../MeasurementPopup"]}}),F=function(e,t){return{url:"api.mapbox.com"===e.slice(8,22)||"tiles.mapbox.com"===e.slice(10,26)?e.replace("?","?pluginName=sheetMapper&"):e}},q=["Lat","Lng","PM1.0 (\xb5g/m\xb3)","PM2.5 (\xb5g/m\xb3)"];function J(){var e;!function(){var e=(0,s.wl)().value.url,t=(0,A.useRouter)();(0,u.useEffect)((function(){return(e?void 0:t.push("/"))&&void 0}),[e,t])}();var t=(0,s.wl)().value.url,n=(0,l.useQuery)({queryKey:["map-csv"],queryFn:function(){return x(t,q)}}),f=n.isLoading,d=n.error,p=n.data,v=O(u.useState(),2),h=v[0],m=v[1],y=O(u.useState([-122.66155,45.54846]),2),g=y[0],w=y[1];!function(e,t){(0,u.useEffect)((function(){if(e){var r=(0,_.VWR)(e);r[0]<=-1/0||r[0]>=1/0?console.error("infitity detected. bounds skipped"):t(r)}}),[e])}(p,m);var j=u.useRef((0,c.ZP)({accessToken:"pk.eyJ1IjoicGR4Y2xlYW5haXIiLCJhIjoiY2tweDFuZmxpMjFmbzJ3bXVkajd4dDQ4dSJ9.LYiRB4TgOAckcqZGi-cUXg",transformRequest:F})).current,P=O(u.useState(null),2),C=P[0],M=P[1],S=u.useCallback((function(){return C&&M(null)}),[C,M]);if(d)return(0,a.jsxs)("div",{children:[(0,a.jsx)("h1",{children:"Error"}),(0,a.jsx)("p",{children:"string"===typeof d?d:JSON.stringify(d,null,2)})]});if(f)return(0,a.jsx)("div",{className:"flex flex-column w-full content justify-center",children:(0,a.jsx)(b.Z,{className:"animate-spin w-20"})});var k=null===(e=null===p||void 0===p?void 0:p.features[0])||void 0===e?void 0:e.properties;if(!k)return(0,a.jsxs)("p",{style:{padding:10},children:["The datafile provided could not be converted into geojson format. Generally, this occurs because the columns in the data sheet do not match the expected field names. Some rows must have headers:",(0,a.jsx)("br",{})," ",q.join(", ")]});var E=k["PM2.5 Corrected"]?"pm25Corrected":k["PM2.5"]?"PM2.5":"voc";return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(i.default,{children:(0,a.jsx)("link",{href:"https://api.mapbox.com/mapbox-gl-js/v2.3.1/mapbox-gl.css",rel:"stylesheet"})}),0===(null===p||void 0===p?void 0:p.features.length)?(0,a.jsxs)("div",{className:"p-4",children:[(0,a.jsx)("h1",{className:"text-xl",children:"Missing data"}),(0,a.jsx)("p",{children:"The data has been downloaded, but is empty :/"})]}):(0,a.jsxs)(j,{onStyleLoad:R(o().mark((function e(t){var n,a,i,u;return o().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r.e(24).then(r.bind(r,9024));case 2:n=e.sent,a=n.RulerControl,i=n.ZoomControl,n.InspectControl,u=n.StylesControl,t.addControl(new u,"bottom-right"),t.addControl(new i,"bottom-right"),t.addControl(new a,"bottom-right");case 11:case"end":return e.stop()}}),e)}))),className:"content w-full",fitBounds:h,center:g,style:"mapbox://styles/pdxcleanair/ckpx7yno443sa17p6iy65qn95",containerStyle:{height:"100%",width:"100vw"},onClick:S,children:[p&&(0,a.jsx)(L,{geojson:p,type:E,onSelectFeature:function(e){h&&m(void 0),g&&w(e.geometry.coordinates),M(e)}}),C?(0,a.jsx)(T,{title:"Measurements",className:"h-96 overflow-auto",feature:C,onClick:function(e){e.preventDefault()}}):void 0]})]})}}},function(e){e.O(0,[275,485,167,888,179],(function(){return t=551,e(e.s=t);var t}));var t=e.O();_N_E=t}]);
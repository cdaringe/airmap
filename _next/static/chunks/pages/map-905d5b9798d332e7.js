(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[890],{54109:(e,n,t)=>{(window.__NEXT_P=window.__NEXT_P||[]).push(["/map",function(){return t(59938)}])},59938:(e,n,t)=>{"use strict";t.r(n),t.d(n,{default:()=>z});var r=t(34618),o=t(12551),s=t(61760),i=t(70573),a=t(65723),u=t(43794),l=t.n(u),c=t(22155),d=t(13578),f=t(29928);t(8188);var p=t(29766),m=t(33925),h=t(521),v=function(e,n){return(e===m.Dr||e===m.cf||e===m.zo)&&n},g=function(){var e=(0,h.xw)().value,n=e.luggage,t=e.urls,r=e.sensorType,o=(0,p.useRouter)();(0,c.useEffect)(function(){!v(r,n)&&(!t.length||t.some(function(e){return!e}))&&(console.warn("no datasource detected, routing back to homepage"),o.push("/"))},[t,o,r,n])},y=t(33139);function x(e){var n=e.msg;return(0,a.jsxs)("div",{className:"flex justify-center w-full flex-column content",children:[(0,a.jsx)(y.A,{className:"w-20 animate-spin"}),n?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("br",{}),(0,a.jsx)("p",{children:n})]}):null]})}var j=t(88910),b=t(61455),_=t(91249),S=function(e){function n(e){var t;return(0,b._)(this,n),(t=(0,j._)(this,n,[e])).state={error:null},t}return(0,_._)(n,e),n.prototype.render=function(){return this.state.error?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("h1",{children:"Something went wrong."}),(0,a.jsx)("pre",{children:this.state.error})]}):this.props.children},n.getDerivedStateFromError=function(e){return{error:String(e)}},n}(c.Component),w={visibility:"visible"},F=function(e){var n=e.onSelectFeature;return c.useMemo(function(){return{layerId:"pollution",onClick:function(e,t){"Point"===t.geometry.type&&n(t)},onMouseEnter:function(e){e.target.getCanvas().style.cursor="pointer"},onMouseLeave:function(e){e.target.getCanvas().style.cursor=""}}},[n])},k=function(e){var n,t=e.id,r=e.geojson,o=e.circleCases;return r?(0,a.jsx)(d.kL,{id:t,type:"geojson",data:r,children:(0,a.jsx)(d.Wd,{id:t,type:"circle",layout:w,paint:(n=void 0===o?[]:o,{"circle-color":["case"].concat((0,s._)(n),["black"]),"circle-radius":5})})}):null},N=t(26237),E=t(92831),D=function(e){var n=e.dateField,t=e.endDate,o=e.isFilterAfterStart,s=e.isFilterBeforeEnd,i=e.startDate,a=e.unfilteredGeojson;return c.useMemo(function(){if(!o&&!s)return a;if(!n)throw Error("sensor type missing dateField column name");var e=null==a?void 0:a.features;return e?(0,E._)((0,r._)({},a),{features:e.filter(function(e){var r=new Date(e.properties[n]);return(!o||!(r<=i))&&(!s||!(r>=t))})}):a},[n,t,o,s,i,a])},M=t(22774),C=function(e){var n=e.mapRef,t=e.className,r=(0,o._)(c.useState(0),2),s=r[0],i=r[1],a=c.useMemo(function(){return setInterval(function(){i(function(e){return e+1})},50)},[]),u=n.current;c.useEffect(function(){if(u){clearInterval(a);var e=u.getContainer();e.className.includes(t)||(e.className+=" "+t)}},[a,u,t,s])},A=t(67597),R=t.n(A);function I(){return(0,a.jsx)(R(),{children:(0,a.jsx)("link",{href:"https://api.mapbox.com/mapbox-gl-js/v3.9.3/mapbox-gl.css",rel:"stylesheet"})},"mapboxstyle")}function L(e){var n=e.error,t=e.datasource;return(0,a.jsxs)("div",{className:"p-2",children:[(0,a.jsx)("h1",{children:"Error"}),(0,a.jsx)("h2",{children:"Failed to load map data."}),(0,a.jsx)("p",{children:"string"==typeof n?n:(0,a.jsx)("pre",{children:JSON.stringify(n,null,2)})}),(0,a.jsxs)("p",{children:["Are you sure your datasource is correct?",(0,a.jsx)("pre",{children:JSON.stringify(t,null,2)})]})]})}function T(){return(0,a.jsx)("p",{className:"p-2",children:"The datafile provided could not be converted into geojson format. Generally, this occurs because the columns in the data sheet do not match the expected field names."})}var B=t(974),O=t(48747),Y=function(e){return!e.toString().match(/Invalid/)},G=new Date("2020-01-01"),H=new Date("".concat(new Date().getFullYear(),"-12-31")),J=function(e,n){for(var t,r=arguments.length,o=Array(r>2?r-2:0),s=2;s<r;s++)o[s-2]=arguments[s];return null===(t=e.features)||void 0===t?void 0:t.forEach(function(t){return o.forEach(function(r){var o;null===(o=r[n])||void 0===o||o.call(r,e,t)})})},P=function(e){var n,t=e.sensorType,r=e.setIsBottomSheetOpen,s=e.setEndDate,i=e.startDate,u=e.setStartDate,l=e.setMappingField,c=e.setIsMinMaxDynamicRange,d=e.setIsFilteringAfterStart,f=e.setIsFilterBeforeEnd,p=e.levels,h=e.isMinMaxDynamicRange,v=e.isBottomSheetOpen,g=e.isFilterBeforeEnd,y=e.isFilterAfterStart,x=e.getLevelsByField,j=e.endDate,b=e.setCountForceRerender,_=null!==(n=m.mY[t])&&void 0!==n?n:"Unknown Sensor";return(0,a.jsxs)("div",{id:"pollution-map-overlay",className:"map-overlay",children:[(0,a.jsxs)("div",{className:"map-overlay-control map-legend",children:["Sensor: ",_]}),(0,a.jsxs)("div",{className:"map-overlay-control map-legend",children:[(0,a.jsx)("div",{style:{fontWeight:"bold"},children:null==p?void 0:p.fieldName}),null==p?void 0:p.ranges.map(function(e,n){var t=(0,o._)(e,2),r=t[0],s=t[1];return(0,a.jsxs)("div",{children:[(0,a.jsx)("span",{style:{backgroundColor:p.colors[n]},className:"map-legend-key"}),(0,a.jsxs)("span",{children:["[",r<1?r.toFixed(3):r.toFixed(1),","," ",s<1?s.toFixed(3):s.toFixed(1),")"]})]},"".concat(h,"-").concat(n))})]}),x?(0,a.jsxs)("div",{className:"map-overlay-control map-pollution-range-mode",children:[(0,a.jsx)("h4",{className:"font-bold",children:"Field to map"}),Object.keys(x).map(function(e,n){return(0,a.jsxs)("div",{children:[(0,a.jsx)("input",{type:"radio",name:"field-to-map",onClick:function(){return l(e)},defaultChecked:0===n},e),(0,a.jsx)("label",{htmlFor:"field-to-map",children:" ".concat(e)}),(0,a.jsx)("br",{})]},e)})]}):null,(0,a.jsxs)("div",{className:"map-overlay-control map-pollution-range-mode",children:[(0,a.jsx)("input",{type:"checkbox",checked:h,onChange:function(){return c(!h)}})," ","Dynamic Levels"]}),(0,a.jsxs)("div",{className:"map-overlay-control map-pollution-range-mode",children:[(0,a.jsx)("input",{type:"checkbox",checked:y,onChange:function(){return d(!y)}})," ","After Date",(0,a.jsx)("br",{}),(0,a.jsx)("input",{type:"datetime-local",disabled:!y,value:(0,B.A)(i,"yyyy-MM-dd'T'HH:mm"),onChange:function(e){var n=new Date(e.currentTarget.value);Y(n)&&u(n)}})]}),(0,a.jsxs)("div",{className:"map-overlay-control map-pollution-range-mode",children:[(0,a.jsx)("input",{type:"checkbox",checked:g,onChange:function(){return f(!g)}})," ","End Date",(0,a.jsx)("br",{}),(0,a.jsx)("input",{type:"datetime-local",disabled:!g,value:(0,B.A)(j,"yyyy-MM-dd'T'HH:mm"),onChange:function(e){var n=new Date(e.currentTarget.value);Y(n)&&s(n)}})]}),t===m.Dr||t===m.cf||t===m.zo?(0,a.jsx)("div",{className:"map-overlay-control map-pollution-range-mode",children:(0,a.jsx)(O.A,{onClick:function(){r(!v)},children:"Show charts"})}):null,t===m.cf?(0,a.jsxs)("div",{className:"map-overlay-control map-pollution-range-mode",children:[(0,a.jsx)("label",{htmlFor:"isoscalar",children:"Isobutylene scalar"}),":",(0,a.jsx)("input",{id:"isoscalar",className:"ml-1",type:"input",defaultValue:1,onChange:function(e){var n=Number(e.currentTarget.value);Number.isFinite(n)&&(window.__AEROQUAL_S500_SCALAR__=n,b(function(e){return e+1}))}})]}):null]})},q=l()(function(){return Promise.all([t.e(991),t.e(996)]).then(t.bind(t,15996)).then(function(e){return e.MapBottomSheet})},{loadableGenerated:{webpack:function(){return[15996]}},ssr:!1}),X=l()(function(){return t.e(224).then(t.bind(t,14224))},{loadableGenerated:{webpack:function(){return[14224]}},ssr:!1});function z(){g();var e,n=(0,o._)((0,c.useState)(""),2),t=n[0],u=n[1],l=(0,o._)((0,c.useState)(!0),2),p=l[0],m=l[1],y=(0,o._)((0,c.useState)(!1),2),j=y[0],b=y[1],_=(0,o._)((0,c.useState)(G),2),w=_[0],E=_[1],A=(0,o._)((0,c.useState)(!1),2),R=A[0],B=A[1],O=(0,o._)((0,c.useState)(H),2),Y=O[0],z=O[1],Q=(0,o._)((0,c.useState)(!1),2),K=Q[0],W=Q[1],U=(0,o._)(c.useState(),2),V=U[0],Z=U[1],$=(0,o._)(c.useState([-122.66155,45.54846]),2),ee=$[0],en=$[1],et=(0,o._)(c.useState(0),2),er=et[0],eo=et[1],es=(0,h.xw)(),ei=es.value,ea=ei.urls,eu=ei.sensorType,el=(0,M.useSensorMappingResources)(eu),ec=el.isLoading,ed=el.error,ef=el.data,ep=ef||{},em=ep.mapbox,eh=void 0===em?{}:em,ev=eh.getLevels,eg=eh.getLevelsByField,ey=ep.processGeoJSONMemoKey,ex=ep.processGeoJSON,ej=t?null==eg?void 0:eg[t]:ev,eb=(null==ef?void 0:ef.download)||{},e_=eb.downloadGeoJSON,eS=eb.dateField,ew=(0,f.useQuery)({queryKey:["map","sensor-".concat(eu)].concat((0,s._)(ea),[void 0===e_?"undefined":(0,i._)(e_)]),queryFn:function(){var e,n=null===(e=es.value)||void 0===e?void 0:e.luggage;return n&&v(eu,n)?Promise.resolve(n):e_?e_(ea):Promise.resolve({type:"FeatureCollection",features:[]})},cacheTime:1e9}),eF=ew.isLoading,ek=ew.error,eN=ew.data,eE=ed||ek,eD=D({unfilteredGeojson:eN,dateField:eS||"",startDate:w,isFilterAfterStart:j,isFilterBeforeEnd:R,endDate:Y}),eM=(0,c.useMemo)(function(){return ej&&eD?ej({isMinMaxDynamicRange:p,geojson:eD}):null},[ej,p,eD]);(0,c.useEffect)(function(){if(eD){var e=(0,N.Qk1)(eD);if(e[0]<=-1/0||e[0]>=1/0){console.error("infinity detected. bounds skipped");return}Z(e)}},[eD]);var eC=(0,o._)(c.useState(null),2),eA=eC[0],eR=eC[1],eI=function(){return eR(null)},eL=c.useRef(null);C({mapRef:eL,className:"w-full content"}),(0,c.useEffect)(function(){var e=function(e){e.key.match(/esc/i)&&eI()},n=function(e){return eI()},t=(0,o._)(document.getElementsByTagName("canvas")||[],1)[0];return null==t||t.addEventListener("click",n),window.addEventListener("keyup",e),function(){window.removeEventListener("keyup",e),null==t||t.removeEventListener("click",n)}},[eA]);var eT=F({onSelectFeature:c.useCallback(function(e){V&&Z(void 0);var n=e.geometry.coordinates;ee&&n&&en(n);var t=(0,r._)({},e);["channels","debug","pocketlabsEntry","pm05EndCol"].forEach(function(e){var n=t.properties;n&&delete n[e]}),eR(e)},[ee,V,eR])}),eB=c.useMemo(function(){return eD&&ex?ex(eD):eD},[eD,null==ey?void 0:ey(),er]);if(eE)return(0,a.jsx)(L,{error:eE,datasource:es});if(ec||eF)return(0,a.jsx)(x,{msg:"Downloading data"});if(!eB)return(0,a.jsx)(x,{msg:"Preparing geojson"});var eO=null==eB?void 0:null===(e=eB.features[0])||void 0===e?void 0:e.properties;return(0,a.jsxs)(S,{children:[(0,a.jsx)(I,{}),(0,a.jsx)(d.T5,{style:{width:"100vw",height:"100%"},onClick:function(e){return J(e,"onClick",eT)},onMouseEnter:function(e){return J(e,"onMouseEnter",eT)},onMouseLeave:function(e){return J(e,"onMouseLeave",eT)},interactiveLayerIds:[eT.layerId],initialViewState:{longitude:ee[0],latitude:ee[1],zoom:12},mapboxAccessToken:"pk.eyJ1IjoicGR4Y2xlYW5haXIiLCJhIjoiY2tweDFuZmxpMjFmbzJ3bXVkajd4dDQ4dSJ9.LYiRB4TgOAckcqZGi-cUXg",mapStyle:"mapbox://styles/pdxcleanair/ckpx7yno443sa17p6iy65qn95",ref:eL,children:(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(k,{id:eT.layerId,geojson:eB,circleCases:null==eM?void 0:eM.circleCases}),eO?void 0:(0,a.jsx)(T,{}),eA?(0,a.jsx)(X,{title:"Measurements",className:"overflow-auto h-96",feature:eA}):null,eM?(0,a.jsx)(P,{sensorType:eu,startDate:w,setEndDate:z,setStartDate:E,setMappingField:u,setIsMinMaxDynamicRange:m,setIsFilteringAfterStart:b,setCountForceRerender:eo,setIsFilterBeforeEnd:B,setIsBottomSheetOpen:W,levels:eM,isMinMaxDynamicRange:p,isFilterBeforeEnd:R,isFilterAfterStart:j,isBottomSheetOpen:K,getLevelsByField:eg,endDate:Y}):null]})}),K?(0,a.jsx)(q,{isOpen:K,onDismiss:W,geojson:eB,sensorId:eu}):null]})}},48747:(e,n,t)=>{"use strict";t.d(n,{A:()=>u});var r=t(34618),o=t(58139),s=t(65723),i=t(70851);t(22155);var a={bg:"bg-gray-600 hover:bg-gray-700 focus:ring-gray-500 focus:ring-offset-gray-200",display:"flex"};let u=function(e){var n=e.styles,t=void 0===n?{}:n,u=t.bg,l=void 0===u?a.bg:u,c=t.display,d=void 0===c?a.display:c,f=e.type,p=e.className,m=(0,o._)(e,["styles","type","className"]),h=(0,i.A)(p,l,d,"py-2 px-4 justify-center items-center text-white transition ease-in duration-200 text-center text-base font-semibold shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 rounded-lg",m.disabled?"bg-gray-400 hover:bg-gray-400 cursor-not-allowed":"");return(0,s.jsx)("button",(0,r._)({type:void 0===f?"button":f,className:h},m))}},22774:(e,n,t)=>{"use strict";t.r(n),t.d(n,{getAeroqualS5000:()=>d,getAirmapGps:()=>c,getFlow:()=>u,getMiniWras:()=>l,getPocket:()=>a,getTigerXt:()=>f,useSensorMappingResources:()=>p});var r=t(48967),o=t(65959),s=t(29928),i=t(33925),a=function(){return t.e(994).then(t.bind(t,26994)).then(function(e){return e.getResources()})},u=function(){var e;return t.e(881).then(t.bind(t,66881)).then((e=(0,r._)(function(e){return(0,o.YH)(this,function(n){return[2,e.getResources()]})}),function(n){return e.apply(this,arguments)}))},l=function(){var e;return t.e(867).then(t.bind(t,67867)).then((e=(0,r._)(function(e){return(0,o.YH)(this,function(n){return[2,e.getResources()]})}),function(n){return e.apply(this,arguments)}))},c=function(){var e;return t.e(109).then(t.bind(t,38109)).then((e=(0,r._)(function(e){return(0,o.YH)(this,function(n){return[2,e.getResources()]})}),function(n){return e.apply(this,arguments)}))},d=function(){var e;return t.e(12).then(t.bind(t,11012)).then((e=(0,r._)(function(e){return(0,o.YH)(this,function(n){return[2,e.getResources()]})}),function(n){return e.apply(this,arguments)}))},f=function(){var e;return t.e(571).then(t.bind(t,57571)).then((e=(0,r._)(function(e){return(0,o.YH)(this,function(n){return[2,e.getResources()]})}),function(n){return e.apply(this,arguments)}))},p=function(e){return(0,s.useQuery)({queryKey:"get-mapping-".concat(e),queryFn:(0,r._)(function(){return(0,o.YH)(this,function(n){switch(n.label){case 0:return[4,e===i.Ke?a():e===i.tH?u():e===i.Dr?l():e===i.cZ?c():e===i.cf?d():e===i.zo?f():function(){throw Error("unsupported sensor type ".concat(e))}()];case 1:return[2,n.sent()]}})}),cacheTime:1e9})}}},e=>{var n=n=>e(e.s=n);e.O(0,[175,681,636,593,792],()=>n(54109)),_N_E=e.O()}]);
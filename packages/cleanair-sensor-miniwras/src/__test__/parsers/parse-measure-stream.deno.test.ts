import { assertEquals } from "https://deno.land/std@0.129.0/testing/asserts.ts";
import { parse } from "../../streams/parse-measure-stream.ts";

/**
 * CSV online: https://docs.google.com/spreadsheets/d/1XqB95gipLDOOsCfYFMV1RXREYUp14POM0fnV1hNRekA/edit#gid=802667302
 */
const csv =
  `Time,Scan #,10.00 nm,14.00 nm,19.00 nm,27.00 nm,37.00 nm,52.00 nm,72.00 nm,100.00 nm,139.00 nm,193.00 nm,274.58 nm,323.88 nm,381.74 nm,449.48 nm,530.18 nm,625.38 nm,737.02 nm,867.18 nm,1021.47 nm,1205.86 nm,1424.96 nm,1679.58 nm,1978.13 nm,2332.27 nm,2745.80 nm,3238.77 nm,3817.43 nm,4499.40 nm,5307.20 nm,6253.83 nm,7370.21 nm,8685.62 nm,10240.20 nm,12069.47 nm,14226.56 nm,16773.33 nm,19768.32 nm,23301.03 nm,27467.18 nm,32375.50 nm,38162.42 nm,Inhalable [ug/m3],Thoracic [ug/m3],Alveolar [ug/m3],pm10 [ug/m3],pm2.5 [ug/m3],pm1 [ug/m3],ID:N,Meas_Nr,Ic[nA],HV[V],Um[V],RH[%],T[0C],Err0,Err1,Loc,GF,Err2,Qbatt,Im,Sensor Ue4,Sensor Ue3,Sensor Ue2 (RH [%]),Sensor Ue1 (T [Â°C]),Iv,ID:M,Ivv Dev,LV Error
2022/10/04 13:57:27,1,3.23E+01,4.45E+01,4.98E+01,4.98E+01,4.78E+01,4.40E+01,3.57E+01,2.35E+01,1.27E+01,4.71E+00,1.00E+00,6.91E-02,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,1.51E-04,1.51E-04,1.51E-04,1.51E-04,1.51E-04,1.51E-04,N,20,2.503,3331,5.03,39.9,23.8,1,1,1,20,0,130,21,,,0,0,0,Mc,9.07E+00,0
2022/10/04 13:58:27,2,1.88E+02,2.35E+02,2.27E+02,1.75E+02,1.34E+02,9.49E+01,7.48E+01,5.00E+01,2.75E+01,1.05E+01,1.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,1.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,NaN,NaN,NaN,NaN,NaN,NaN,N,30,2.502,3327,5.03,39.9,23.9,1,1,1,20,0,130,21,,,0,0,0,Mc,9.48E+00,0
2022/10/04 13:59:27,3,3.23E+01,4.45E+01,4.98E+01,4.98E+01,4.78E+01,4.40E+01,3.57E+01,2.35E+01,1.27E+01,4.71E+00,1.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,2.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,NaN,NaN,NaN,NaN,NaN,NaN,N,40,2.5,3324,5.03,39.7,24,1,1,1,20,0,130,21,,,0,0,0,Mc,9.94E+00,0
2022/10/04 14:00:27,4,3.23E+01,4.45E+01,4.98E+01,4.98E+01,4.78E+01,4.40E+01,3.57E+01,2.35E+01,1.27E+01,4.71E+00,1.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,3.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,NaN,NaN,NaN,NaN,NaN,NaN,N,50,2.5,3322,5.03,39.7,24.1,1,1,1,20,0,130,21,,,0,0,0,Mc,9.09E+00,0
2022/10/04 14:01:27,5,3.47E+02,4.31E+02,4.03E+02,2.79E+02,1.74E+02,6.89E+01,3.36E+01,1.57E+01,8.08E+00,2.90E+00,1.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,4.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,NaN,NaN,NaN,NaN,NaN,NaN,N,60,2.5,3320,5.03,39.7,24.2,1,1,1,20,0,130,21,,,0,0,0,Mc,9.83E+00,0
2022/10/04 14:02:27,6,3.23E+01,4.45E+01,4.98E+01,4.98E+01,4.78E+01,4.40E+01,3.57E+01,2.35E+01,1.27E+01,4.71E+00,1.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,5.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,NaN,NaN,NaN,NaN,NaN,NaN,N,70,2.5,3318,5.03,39.6,24.3,1,1,1,20,0,130,21,,,0,0,0,Mc,9.28E+00,0
2022/10/04 14:03:27,7,2.47E+02,3.06E+02,2.85E+02,1.93E+02,1.15E+02,3.60E+01,1.70E+01,8.48E+00,4.22E+00,2.11E+00,1.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,4.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,NaN,NaN,NaN,NaN,NaN,NaN,N,80,2.501,3317,5.03,39.6,24.4,1,1,1,20,0,130,21,,,0,0,0,Mc,9.88E+00,0
2022/10/04 14:04:27,8,3.23E+01,4.45E+01,4.98E+01,4.98E+01,4.78E+01,4.40E+01,3.57E+01,2.35E+01,1.27E+01,4.71E+00,1.00E+00,6.91E-02,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,3.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,1.51E-04,1.51E-04,1.51E-04,1.51E-04,1.51E-04,1.51E-04,N,90,2.5,3315,5.03,39.4,24.4,1,1,1,20,0,130,20,,,0,0,0,Mc,9.33E+00,0
2022/10/04 14:05:27,9,3.24E+02,4.01E+02,3.73E+02,2.53E+02,1.51E+02,4.71E+01,1.95E+01,9.39E+00,4.53E+00,2.19E+00,1.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,2.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,NaN,NaN,NaN,NaN,NaN,NaN,N,100,2.499,3314,5.02,39.5,24.5,1,1,1,20,0,130,20,,,0,0,0,Mc,9.86E+00,0
2022/10/04 14:06:27,10,3.23E+01,4.45E+01,4.98E+01,4.98E+01,4.78E+01,4.40E+01,3.57E+01,2.35E+01,1.27E+01,4.71E+00,1.00E+00,6.91E-02,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,-1.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,1.51E-04,1.51E-04,1.51E-04,1.51E-04,1.51E-04,1.51E-04,N,110,2.499,3313,5.03,39.4,24.6,1,1,1,20,0,130,20,,,0,0,0,Mc,9.90E+00,0
2022/10/04 14:07:27,11,3.44E+02,4.26E+02,3.96E+02,2.68E+02,1.60E+02,5.00E+01,2.01E+01,9.61E+00,4.59E+00,2.20E+00,1.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,0.00E+00,NaN,NaN,NaN,NaN,NaN,NaN,N,120,2.5,3312,5.03,39.3,24.8,1,1,1,20,0,130,20,,,0,0,0,Mc,1.01E+01,0`;

Deno.test({
  name: "stream - parse",
  fn: async () => {
    const stream = new ReadableStream({
      start(controller) {
        controller.enqueue(csv);
        controller.close();
      },
    });
    const parsed = await parse(stream.getReader());
    assertEquals(parsed.partial, "");
    assertEquals(parsed.records, [
      {
        date: new Date("2022-10-04T20:57:27.000Z"),
        pm_2_3: 0,
        pm_2_7: 0,
      },
      {
        date: new Date("2022-10-04T20:58:27.000Z"),
        pm_2_3: 0,
        pm_2_7: 1,
      },
      {
        date: new Date("2022-10-04T20:59:27.000Z"),
        pm_2_3: 0,
        pm_2_7: 2,
      },
      {
        date: new Date("2022-10-04T21:00:27.000Z"),
        pm_2_3: 0,
        pm_2_7: 3,
      },
      {
        date: new Date("2022-10-04T21:01:27.000Z"),
        pm_2_3: 0,
        pm_2_7: 4,
      },
      {
        date: new Date("2022-10-04T21:02:27.000Z"),
        pm_2_3: 0,
        pm_2_7: 5,
      },
      {
        date: new Date("2022-10-04T21:03:27.000Z"),
        pm_2_3: 0,
        pm_2_7: 4,
      },
      {
        date: new Date("2022-10-04T21:04:27.000Z"),
        pm_2_3: 0,
        pm_2_7: 3,
      },
      {
        date: new Date("2022-10-04T21:05:27.000Z"),
        pm_2_3: 0,
        pm_2_7: 2,
      },
      {
        date: new Date("2022-10-04T21:06:27.000Z"),
        pm_2_3: 0,
        pm_2_7: -1,
      },
      {
        date: new Date("2022-10-04T21:07:27.000Z"),
        pm_2_3: 0,
        pm_2_7: 0,
      },
    ]);
    assertEquals(parsed.records.length, 11);
  },
});
